# ruta: rasa/domain_parts/domain_autenticacion.yml
version: "3.1"

intents:
  - solicitar_soporte
  - necesita_humano
  - iniciar_encuesta
  - auth_login_cmd
  - enviar_credenciales
  - confirmar_autenticacion
  - deny
  - affirm
  - recuperar_contrasena
  - provide_email
  - estado_estudiante
  - ver_certificados
  - fallback

entities:
  - email
  - password
  - prefer_contacto
  - motivo_soporte
  - phone

slots:

  # Mantener igual a otras partes del dominio para evitar conflictos
  is_authenticated:
    type: bool
    influence_conversation: true
    initial_value: false
    mappings:
      - type: from_trigger_intent
        value: true
        intent: confirmar_autenticacion
      - type: from_trigger_intent
        value: false
        intent: deny

  # Credenciales de login
  email:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: email
      - type: from_text
        conditions:
          - active_loop: auth_login_form
            requested_slot: email
          - active_loop: password_recovery_form
            requested_slot: email

  password:
    type: text
    influence_conversation: false
    mappings:
      - type: from_text
        conditions:
          - active_loop: auth_login_form
            requested_slot: password

  # Soporte
  motivo_soporte:
    type: categorical
    values: ["acceso", "calificaciones", "certificados", "tecnico", "otro"]
    influence_conversation: true
    mappings:
      - type: from_entity
        entity: motivo_soporte
      - type: from_intent
        intent: solicitar_soporte
        value: "otro"
      - type: from_text
        conditions:
          - active_loop: soporte_form
            requested_slot: motivo_soporte

  prefer_contacto:
    type: categorical
    values: ["email", "whatsapp", "ninguno"]
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: prefer_contacto
      - type: from_text
        conditions:
          - active_loop: soporte_form
            requested_slot: prefer_contacto

  phone:
    type: text
    influence_conversation: false
    mappings:
      - type: from_entity
        entity: phone
      - type: from_text
        conditions:
          - active_loop: soporte_form
            requested_slot: phone

forms:
  auth_login_form:
    required_slots:
      - email
      - password

  password_recovery_form:
    required_slots:
      - email

responses:

  # ===== GENÃ‰RICOS / FLOW =====
  utter_saludo:
    - text: "Â¡Hola! ğŸ‘‹ Â¿En quÃ© puedo ayudarte hoy?"

  utter_fallback:
    - text: "Lo siento, no entendÃ­ tu mensaje. Intenta reformularlo o escribe 'ayuda'."

  utter_espera_agente:
    - text: "ğŸ§‘â€ğŸ’» Te conecto con un agente humano, por favor espera..."

  utter_ofrecer_continuar:
    - text: "Â¿Deseas continuar con este tema o abrir un caso de soporte?"
      buttons:
        - title: "SÃ­, continuar"
          payload: "/affirm"
        - title: "No, enviar soporte"
          payload: "/deny"

  # ===== AUTENTICACIÃ“N =====
  utter_need_auth:
    - text: "âš ï¸ Para realizar esta acciÃ³n necesitas iniciar sesiÃ³n."
      buttons:
        - title: "Iniciar sesiÃ³n"
          payload: "/auth_login_cmd"
        - title: "Cancelar"
          payload: "/deny"

  utter_auth_ok:
    - text: "âœ… AutenticaciÃ³n correcta. Â¿QuÃ© deseas consultar?"
      buttons:
        - title: "ğŸ“ Estado acadÃ©mico"
          payload: "/estado_estudiante"
        - title: "ğŸ“„ Certificados"
          payload: "/ver_certificados"
        - title: "ğŸ  MenÃº"
          payload: "/ir_menu_principal"

  utter_auth_fail:
    - text: "âš ï¸ No pude iniciar sesiÃ³n con esos datos. Â¿Intentamos de nuevo o recuperamos tu contraseÃ±a?"
      buttons:
        - title: "ğŸ” Reintentar"
          payload: "/enviar_credenciales"
        - title: "ğŸ§· Recuperar contraseÃ±a"
          payload: "/recuperar_contrasena"
        - title: "ğŸ‘¤ Hablar con humano"
          payload: "/necesita_humano"

  # Preguntas de forms
  utter_ask_email:
    - text: "ğŸ“§ IndÃ­came tu correo institucional (ej. nombre@zajuna.edu.co)."
  utter_ask_password:
    - text: "ğŸ”‘ Escribe tu contraseÃ±a."
  utter_ask_phone:
    - text: "ğŸ“± DÃ©jame un nÃºmero de WhatsApp (ej. +57 3xx xxx xxxx)."

  # ===== RECUPERACIÃ“N =====
  utter_recuperacion_enviada:
    - text: "ğŸ“§ Te enviÃ© un correo con instrucciones para restablecer tu contraseÃ±a. Revisa la bandeja de entrada y spam."
      buttons:
        - title: "ğŸ” Volver a iniciar sesiÃ³n"
          payload: "/auth_login_cmd"
        - title: "ğŸ  MenÃº principal"
          payload: "/ir_menu_principal"

actions:
  - action_enviar_soporte
  - action_derivar_y_registrar_humano
  - action_conectar_humano
  - action_preguntar_resolucion
  - action_set_authenticated_true
  - action_check_auth
  - action_ingreso_zajuna
  - action_recuperar_contrasena
  - action_enviar_correo_recuperacion
