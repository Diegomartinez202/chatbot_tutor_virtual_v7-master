#\rules\rules_terminar_conversacion_segura_autosave.yml
version: "3.1"

rules:

  # 1) Usuario pide terminar con cierre seguro/autosave
  - rule: Verificar proceso activo antes de cierre seguro
    steps:
      - intent: terminar_conversacion_segura_autosave
      - action: action_verificar_proceso_activo_autosave

  # 2) Usuario confirma cierre y hay encuesta incompleta â†’ guardar + cerrar
  - rule: Confirmar cierre seguro con encuesta incompleta
    condition:
      - slot_was_set:
          - encuesta_incompleta: true
    steps:
      - intent: confirmar_cierre_autosave
      - action: action_guardar_encuesta_incompleta
      - action: action_confirmar_cierre_autosave

  # 3) Usuario confirma cierre sin encuesta incompleta â†’ solo cerrar
  - rule: Confirmar cierre seguro sin encuesta incompleta
    steps:
      - intent: confirmar_cierre_autosave
      - action: action_confirmar_cierre_autosave

  # 4) Usuario cancela el cierre
  - rule: Cancelar cierre seguro con autosave
    steps:
      - intent: cancelar_cierre_autosave
      - action: action_cancelar_cierre_autosave
  # ðŸ”¹ Terminar conversaciÃ³n segura + autosave dentro de soporte_form
  - rule: Terminar conversaciÃ³n segura con autosave dentro de soporte_form
    condition:
      - active_loop: soporte_form
    steps:
      - intent: terminar_conversacion_segura_autosave
      - action: action_deactivate_loop
      - active_loop: null
      - action: action_verificar_proceso_activo_autosave