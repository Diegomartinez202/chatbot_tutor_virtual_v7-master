version: "3.1"
rules:

  # =============================
  # Consultas condicionales por autenticación (SIN acción intermedia)
  # =============================

  - rule: Estado estudiante (autenticado)
    condition:
      - slot_was_set:
          - is_authenticated: true
    steps:
      - intent: estado_estudiante   # o ver_estado_estudiante si lo usas
      - action: action_check_auth   # opcional si sincronizas token → slot
      - action: action_check_auth_estado    # si la tienes para validar y setear slot
      - action: action_estado_estudiante    # tu acción que trae el estado real (alias: zajuna_get_estado_estudiante)
      # Si prefieres, reemplaza por la acción exacta que usas hoy.

  - rule: Estado estudiante (NO autenticado)
    condition:
      - slot_was_set:
          - is_authenticated: false
    steps:
      - intent: estado_estudiante
      - action: action_check_auth     # opcional; no rompe si ya está en false
      - action: utter_need_auth       # ===> Debe existir en domain (ya lo dejamos)

  - rule: Consultar certificados (autenticado)
    condition:
      - slot_was_set:
          - is_authenticated: true
    steps:
      - intent: consultar_certificados
      - action: action_check_auth
      - action: action_ver_certificados   # alias: zajuna_get_certificados
      - action: utter_certificados_carousel   # response avanzada (ya creada)

  - rule: Consultar certificados (NO autenticado)
    condition:
      - slot_was_set:
          - is_authenticated: false
    steps:
      - intent: consultar_certificados
      - action: action_check_auth
      - action: utter_need_auth

  # =============================
  # Inicio de login por intent dedicado
  # =============================

  - rule: Iniciar login por enviar_credenciales
    steps:
      - intent: enviar_credenciales
      - action: auth_login_form
      - active_loop: auth_login_form

  # Submit OK del auth_login_form
  - rule: Submit auth_login_form OK
    condition:
      - active_loop: auth_login_form
    steps:
      - action: auth_login_form
      - active_loop: null
      - action: action_ingreso_zajuna       # crea/sincroniza sesión con Zajuna
      - action: action_check_auth            # setea is_authenticated según token
      - slot_was_set:
          - is_authenticated: true
      - action: utter_auth_ok

  # Submit FAIL del auth_login_form
  - rule: Submit auth_login_form FAIL
    condition:
      - active_loop: auth_login_form
    steps:
      - action: auth_login_form
      - active_loop: null
      - action: action_check_auth
      - slot_was_set:
          - is_authenticated: false
      - action: utter_auth_fail

  # =============================
  # Confirmación de autenticación por botón
  # =============================

  - rule: Confirmar autenticación directa (botón)
    steps:
      - intent: confirmar_autenticacion
      - action: action_set_authenticated_true
      - action: utter_auth_ok

  # =============================
  # Recuperación de contraseña (form + submit)
  # =============================

  - rule: Iniciar recuperación por recuperar_contrasena
    steps:
      - intent: recuperar_contrasena
      - action: password_recovery_form
      - active_loop: password_recovery_form

  - rule: Submit password_recovery_form
    condition:
      - active_loop: password_recovery_form
    steps:
      - action: password_recovery_form
      - active_loop: null
      - action: action_recuperar_contrasena
      - action: action_enviar_correo_recuperacion
      - action: utter_recuperacion_enviada

  # =============================
  # Soporte rápido (affirm/deny)
  # =============================

  - rule: Soporte → usuario afirma
    steps:
      - intent: solicitar_soporte
      - action: action_ofrecer_continuar_tema
      - intent: affirm
      - action: action_enviar_soporte

  - rule: Soporte → usuario niega
    steps:
      - intent: solicitar_soporte
      - action: action_ofrecer_continuar_tema
      - intent: deny
      - action: utter_saludo

  # =============================
  # Derivación a humano directa
  # =============================

  - rule: Escalar siempre a humano
    steps:
      - intent: necesita_humano
      - action: action_derivar_y_registrar_humano
      - action: action_conectar_humano

  # =============================
  # Encuesta desde intención
  # =============================

  - rule: Registro de encuesta desde iniciar_encuesta
    steps:
      - intent: iniciar_encuesta
      - action: action_preguntar_resolucion
      - intent: affirm
      - action: action_registrar_encuesta   # ← corregido el typo
