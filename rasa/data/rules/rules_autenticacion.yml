version: "3.1"

rules:

  # =============================
  # Consultas condicionales por autenticación
  # =============================
  - rule: Estado estudiante (autenticado)
    condition:
      - slot_was_set:
          - is_authenticated: true
    steps:
      - intent: estado_estudiante
      - action: action_check_auth
      - action: action_estado_estudiante

  - rule: Estado estudiante (NO autenticado)
    condition:
      - slot_was_set:
          - is_authenticated: false
    steps:
      - intent: estado_estudiante
      - action: action_check_auth
      - action: utter_need_auth

  - rule: Consultar certificados (autenticado)
    condition:
      - slot_was_set:
          - is_authenticated: true
    steps:
      - intent: ver_certificados
      - action: action_check_auth
      - action: action_ver_certificados

  - rule: Consultar certificados (NO autenticado)
    condition:
      - slot_was_set:
          - is_authenticated: false
    steps:
      - intent: ver_certificados
      - action: action_check_auth
      - action: utter_need_auth

  # =============================
  # Inicio de login por intent dedicado
  # =============================
  - rule: Iniciar login (enviar_credenciales)
    steps:
      - intent: enviar_credenciales
      - action: auth_login_form
      - active_loop: auth_login_form

  - rule: Submit auth_login_form OK
    condition:
      - active_loop: auth_login_form
    steps:
      - action: auth_login_form
      - active_loop: null
      - action: action_ingreso_zajuna
      - action: action_set_authenticated_true
      - action: utter_auth_ok

  - rule: Submit auth_login_form FAIL (manual)
    steps:
      - intent: deny
      - action: utter_auth_fail

  # =============================
  # Confirmación de autenticación por botón
  # =============================
  - rule: Confirmar autenticación directa
    steps:
      - intent: confirmar_autenticacion
      - action: action_set_authenticated_true
      - action: utter_auth_ok

  # =============================
  # Recuperación de contraseña (form + submit)
  # =============================
  - rule: Iniciar recuperación por intent
    steps:
      - intent: recuperar_contrasena
      - action: password_recovery_form
      - active_loop: password_recovery_form

  - rule: Submit password_recovery_form
    condition:
      - active_loop: password_recovery_form
    steps:
      - action: password_recovery_form
      - active_loop: null
      - action: action_recuperar_contrasena
      - action: action_enviar_correo_recuperacion
      - action: utter_recuperacion_enviada

  # =============================
  # Soporte rápido (affirm/deny)
  # =============================
  - rule: Soporte → usuario afirma
    steps:
      - intent: solicitar_soporte
      - action: utter_ofrecer_continuar
      - intent: affirm
      - action: action_enviar_soporte

  - rule: Soporte → usuario niega
    steps:
      - intent: solicitar_soporte
      - action: utter_ofrecer_continuar
      - intent: deny
      - action: utter_saludo

  # =============================
  # Derivación a humano
  # =============================
  - rule: Escalar siempre a humano
    steps:
      - intent: necesita_humano
      - action: action_derivar_y_registrar_humano
      - action: action_conectar_humano

  # =============================
  # Encuesta desde intención
  # =============================
  - rule: Registro de encuesta desde iniciar_encuesta
    steps:
      - intent: iniciar_encuesta
      - action: action_preguntar_resolucion
