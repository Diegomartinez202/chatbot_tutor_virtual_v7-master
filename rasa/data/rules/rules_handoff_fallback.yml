version: "3.1"

rules:

  # 1) Fallback dentro de soporte_form: contar intentos y reintentar
  - rule: Fallback dentro de soporte_form (contar intentos)
    condition:
      - active_loop: soporte_form
    steps:
      - intent: nlu_fallback
      - action: action_registrar_intento_form
      - action: action_verificar_max_intentos_form
      - action: utter_form_fallback_warn
      - action: soporte_form
      - active_loop: soporte_form

  # 2) Si el contador se reseteó a 0 (>=3 fallos) → cerrar form y derivar a humano
  - rule: Derivar a humano tras 3 fallos en soporte_form
    condition:
      - active_loop: soporte_form
    steps:
      - slot_was_set:
          - soporte_intentos: 0    # se pone a 0 cuando supera MAX_INTENTOS_FORM
      - action: action_deactivate_loop
      - active_loop: null
      - action: utter_handoff_por_fallos
      - action: action_derivar_humano_confirmada

  # 3) Si el usuario dice terminar dentro del form → salir del form y lanzar flujo de cierre
  - rule: Terminar conversación dentro de soporte_form
    condition:
      - active_loop: soporte_form
    steps:
      - intent: terminar_conversacion
      - action: action_deactivate_loop
      - active_loop: null
      - action: action_confirmar_cierre
