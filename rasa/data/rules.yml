version: "3.1"

rules:

  - rule: Men√∫ principal por regla
    steps:
      - intent: ir_menu_principal
      - action: action_ir_menu_principal

  - rule: Limpiar sesi√≥n (alias de reinicio)
    steps:
      - intent: limpiar_sesion
      - action: action_reiniciar_conversacion

  - rule: Ping servidor admin
    steps:
      - intent: ping_servidor
      - action: action_ping_servidor

  - rule: Submit auth_login_form OK
    condition:
      - active_loop: auth_login_form
    steps:
      - action: auth_login_form
      - active_loop: null
      - action: action_ingreso_zajuna
      - action: action_set_authenticated_true
      - action: utter_auth_ok

  - rule: Submit auth_login_form FAIL (manual)
    condition:
      - active_loop: auth_login_form
    steps:
      - intent: deny
      - action: utter_auth_fail

  - rule: Confirmar autenticaci√≥n directa
    steps:
      - intent: confirmar_autenticacion
      - action: action_set_authenticated_true
      - action: utter_auth_ok
      - action: utter_confirmacion_consulta

  - rule: Iniciar recuperaci√≥n por intent
    steps:
      - intent: recuperar_contrasena
      - action: utter_recuperar_acceso_cta
      - action: password_recovery_form
      - active_loop: password_recovery_form

  - rule: Submit password_recovery_form
    condition:
      - active_loop: password_recovery_form
    steps:
      - action: password_recovery_form
      - active_loop: null
      - action: action_recuperar_contrasena
      - action: action_enviar_correo_recuperacion
      - action: utter_recuperacion_enviada
  
  - rule: Iniciar flujo de login pidiendo email
    steps:
      - intent: auth_login_cmd
      - action: utter_ask_email
      - action: auth_login_form
      - active_loop: auth_login_form
  
  - rule: Iniciar login por enviar_credenciales
    steps:
      - intent: enviar_credenciales
      - action: auth_login_form
      - active_loop: auth_login_form

  - rule: Despedida directa
    steps:
      - intent: despedida
      - action: action_finalizar_conversacion

  - rule: Reanudar encuesta si hay pendiente
    condition:
      - slot_was_set:
          - reanudar_pendiente: true
    steps:
      - intent: reanudar_auto_si
      - action: action_reanudar_auto
      - action: utter_reanudar_confirmado

  - rule: No reanudar encuesta
    steps:
      - intent: reanudar_auto_no
      - action: utter_reanudar_cancelado
  
  - rule: Confirmar cierre con autosave (si hay encuesta activa)
    condition:
      - slot_was_set:
          - encuesta_activa: true
    steps:
      - intent: confirmar_cierre
      - action: action_autosave_encuesta
      - action: action_guardar_autosave_mongo
      - action: utter_cierre_confirmado
      - action: action_reset_conversacion_segura

  - rule: Confirmar cierre sin encuesta activa
    condition:
      - slot_was_set:
          - encuesta_activa: false
    steps:
      - intent: confirmar_cierre
      - action: action_finalizar_conversacion

  - rule: Limpiar autosave
    steps:
      - intent: limpiar_autosave
      - action: action_reset_conversacion_segura
      - action: utter_limpiar_autosave

  - rule: Encuesta positiva (encuesta_satis_yes)
    steps:
      - intent: encuesta_satis_yes
      - action: action_set_encuesta_tipo
      - slot_was_set:
          - encuesta_tipo: "positiva"
      - action: utter_agradecimiento_satisfaccion
      - action: utter_ofrecer_continuar

  - rule: Problema resuelto
    steps:
      - intent: problema_resuelto_si
      - action: utter_agradecimiento_satisfaccion
      - action: utter_ofrecer_continuar

  - rule: Cambiar idioma a espa√±ol
    steps:
      - intent: cambiar_idioma_espanol
      - action: utter_cambiar_idioma_espanol

  - rule: Cambiar idioma a ingl√©s
    steps:
      - intent: cambiar_idioma_ingles
      - action: utter_cambiar_idioma_ingles

  - rule: Mostrar cat√°logo
    steps:
      - intent: explorar_temas
      - action: utter_catalogo_cursos
  
  - rule: Guardar snapshot manual (Guardian)
    steps:
      - intent: guardar_snapshot
      - action: action_autosave_snapshot
      - action: utter_guardian_snapshot_ok
  
  - rule: Ayuda sobre Guardian
    steps:
      - intent: ayuda_guardian
      - action: utter_guardian_help
  
  - rule: Confirmar derivaci√≥n a humano (can√≥nica)
    steps:
      - intent: confirmacion_escalar_humano
      - action: action_derivar_y_registrar_humano

  - rule: Negar handoff (intento dedicado)
    steps:
      - intent: negar_handoff
      - action: utter_continuar_con_bot
  
  - rule: Verificar estado de encuesta antes de cerrar
    steps:
      - intent: terminar_conversacion_segura
      - action: action_verificar_estado_encuesta
  
  - rule: Guardar progreso expl√≠cito
    steps:
      - intent: guardian_guardar_progreso
      - action: action_guardian_guardar_progreso

  - rule: Pausar conversaci√≥n segura
    steps:
      - intent: guardian_pausar_conversacion
      - action: action_guardian_pausar

  - rule: Guardar estado en desconexi√≥n
    steps:
      - intent: notificar_desconexion
      - action: action_notificar_desconexion
      - action: action_guardar_estado_seguridad
      - action: utter_notificar_desconexion

  - rule: Reanudar conversaci√≥n autom√°tica
    steps:
      - intent: reanudar_conversacion
      - action: action_cargar_autosave_mongo
      - action: action_autoresume_conversacion

  - rule: Restaurar estado en reconexi√≥n
    steps:
      - intent: notificar_reconexion
      - action: action_recuperar_estado_seguridad
      - action: action_notificar_reconexion
  
  - rule: Guardar estado bajo demanda
    steps:
      - intent: guardar_estado
      - action: action_guardar_estado_seguridad
      - action: utter_guardando_progreso

  - rule: Recuperar estado bajo demanda
    steps:
      - intent: recuperar_estado_seguridad
      - action: action_recuperar_estado_seguridad

  - rule: Usuario satisfecho
    steps:
      - intent: respuesta_satisfecho
      - action: action_set_encuesta_tipo
      - slot_was_set:
          - encuesta_tipo: "positiva"
      - action: utter_agradecimiento_satisfaccion
      - action: utter_ofrecer_continuar

  - rule: Enviar correo a tutor
    steps:
      - intent: enviar_correo_tutor
      - action: action_enviar_correo_tutor
      - action: utter_correo_enviado
      - action: utter_preguntar_continuar_menu

  - rule: Continuar desde encuesta
    steps:
      - intent: continuar_consulta
      - action: utter_menu_principal

  - rule: Derivar a humano (affirm)
    steps:
      - action: utter_ofrecer_humano
      - intent: affirm
      - action: action_derivar_y_registrar_humano
      - action: utter_handoff_iniciado
      - action: utter_derivando_humano
      - action: soporte_form
      - active_loop: soporte_form

  - rule: Confirmar cierre seguro con encuesta incompleta
    condition:
      - slot_was_set:
          - encuesta_incompleta: true
    steps:
      - intent: confirmar_cierre_autosave
      - action: action_guardar_encuesta_incompleta
      - action: action_confirmar_cierre_autosave

  - rule: Confirmar cierre seguro sin encuesta incompleta
    steps:
      - intent: confirmar_cierre_autosave
      - action: action_confirmar_cierre_autosave

  - rule: Cancelar cierre seguro con autosave
    steps:
      - intent: cancelar_cierre_autosave
      - action: action_cancelar_cierre_autosave
  
  - rule: Terminar conversaci√≥n segura con autosave dentro de soporte_form
    condition:
      - active_loop: soporte_form
    steps:
      - intent: terminar_conversacion_segura_autosave
      - action: action_deactivate_loop
      - active_loop: null
      - action: action_verificar_proceso_activo_autosave
  
  - rule: Enviar correo gen√©rico
    steps:
      - intent: enviar_correo
      - action: action_enviar_correo

  - rule: Detectar que necesita autenticaci√≥n
    steps:
      - intent: necesita_auth
      - action: utter_necesita_autenticacion  
  
  - rule: Problema no resuelto -> ofrecer escalamiento
    steps:
      - intent: problema_resuelto_no
      - action: utter_problema_resuelto_no

  - rule: Usuario NO quiere escalar
    steps:
      - intent: negar_escalar
      - action: utter_continuar_con_bot
  
  - rule: Usuario cancela la acci√≥n actual
    steps:
      - intent: cancelar
      - action: utter_cancelar_accion
 
  - rule: Usuario confirma derivaci√≥n a humano
    steps:
      - intent: confirmar_derivacion
      - action: utter_confirmar_derivacion

  - rule: Usuario quiere contactar a su tutor
    steps:
      - intent: contactar_tutor
      - action: utter_contactar_tutor_opciones
      - action: utter_contactar_tutor_confirmacion

  - rule: Usuario quiere continuar con otro tema (continuar_tema_si)
    steps:
      - intent: continuar_tema_si
      - action: utter_continuar_tema_menu

  - rule: Usuario dice 'continue'
    steps:
      - intent: continue
      - action: utter_continuar_tema_menu

  - rule: Usuario inicia feedback directo
    steps:
      - intent: dar_retroalimentacion
      - action: utter_iniciar_retroalimentacion
      - action: feedback_form
      - active_loop: feedback_form
  
  - rule: Usuario reporta error en actividad
    steps:
      - intent: error_actividad
      - action: utter_error_actividad_ayuda
  
  - rule: Usuario pide horarios o calendario
    steps:
      - intent: horarios_calendario
      - action: utter_horarios_calendario_info
  
  - rule: Usuario usa intent iniciar_sesion
    steps:
      - intent: iniciar_sesion
      - action: utter_redirigir_login
 
  - rule: Usuario niega autenticaci√≥n
    steps:
      - intent: negar_autenticacion
      - action: utter_negar_autenticacion
  
  - rule: Usuario reporta otro problema t√©cnico
    steps:
      - intent: otro_problema_tecnico
      - action: utter_otro_problema_tecnico
  
  - rule: Usuario reporta pantalla blanca
    steps:
      - intent: pantalla_blanca
      - action: utter_pantalla_blanca_ayuda
  
  - rule: Usuario tiene problema para ingresar
    steps:
      - intent: problema_no_ingreso
      - action: utter_problema_no_ingreso
  
  - rule: Usuario pide ver proceso acad√©mico
    steps:
      - intent: proceso_academico
      - action: utter_proceso_academico_menu
  
  - rule: Usuario abre submen√∫ acad√©mico
    steps:
      - intent: proceso_academico_secundario
      - action: utter_proceso_academico_secundario_menu
  
  - rule: Usuario env√≠a correo fuera de formularios
    condition:
      - active_loop: null
    steps:
      - intent: provide_email
      - action: utter_confirmar_email
  
  - rule: Usuario pide soporte t√©cnico
    steps:
      - intent: soporte_tecnico
      - action: utter_soporte_tecnico_menu
  
  - rule: Usuario quiere ver link de soporte
    steps:
      - intent: ver_link_soporte
      - action: utter_ver_link_soporte
  
  - rule: Usuario quiere ver informaci√≥n del soporte creado
    steps:
      - intent: ver_soporte_creado_info
      - action: utter_ver_soporte_creado_info

  - rule: Iniciar encuesta de satisfacci√≥n completa
    steps:
      - intent: iniciar_encuesta
      - action: utter_encuesta_satisfaccion
      - action: action_preguntar_resolucion
      - action: feedback_form
      - active_loop: feedback_form

  - rule: Ofrecer derivaci√≥n a humano
    steps:
      - intent: necesita_humano
      - action: utter_pedir_derivacion

  - rule: Mostrar men√∫ principal r√°pido
    steps:
      - intent: menu_rapido
      - action: action_ir_menu_principal

  - rule: Pedir nombre fuera de formulario
    steps:
      - intent: pedir_nombre      
      - action: utter_ask_nombre

  - rule: Reinicio confirmado
    steps:
      - intent: reiniciar_conversacion
      - action: action_reiniciar_conversacion
      - action: utter_reinicio_confirmado

  - rule: Lamentar insatisfacci√≥n
    steps:
      - intent: encuesta_satis_no
      - action: utter_lamentar_insatisfaccion
  
  - rule: Capturar URL de soporte
    steps:
      - intent: enviar_url
      - action: utter_gracias_url
  
  - rule: Usuario decide no continuar con el tema actual
    steps:
      - intent: continuar_tema_no
      - action: utter_no_continuar_tema
      - action: utter_menu_principal

  - rule: Responder saludo del usuario
    steps:
      - intent: saludo
      - action: utter_saludo
      - action: action_auto_resume

  - rule: Pedir password expl√≠citamente en login
    condition:
      - active_loop: auth_login_form
    steps:
      - action: utter_ask_password

  - rule: Preguntar nivel de satisfacci√≥n
    condition:
      - active_loop: encuesta_satisfaccion_form
    steps:
      - action: utter_ask_nivel_satisfaccion

  - rule: Pedir comentario libre de satisfacci√≥n
    condition:
      - active_loop: encuesta_satisfaccion_form
    steps:
      - action: utter_ask_feedback_texto

  - rule: Pedir usuario en feedback_form
    condition:
      - active_loop: feedback_form
    steps:
      - action: utter_ask_usuario

  - rule: Pedir texto de feedback en feedback_form
    condition:
      - active_loop: feedback_form
    steps:
      - action: utter_ask_feedback_texto
  
  - rule: Confirmar cierre seguro
    steps:
      - intent: confirmar_cierre_segura
      - action: action_guardar_progreso_encuesta   
      - action: action_confirmar_cierre_seguro
      - action: utter_cierre_confirmado_seguro

  - rule: Cancelar cierre seguro
    steps:
      - intent: cancelar_cierre_segura
      - action: action_cancelar_cierre_segura
      - action: utter_cierre_cancelado_seguro
      - action: action_ir_menu_principal
  
  - rule: Flujo base - usuario quiere terminar conversaci√≥n
    steps:
      - intent: terminar_conversacion
      - action: action_verificar_proceso_activo_autosave
      - action: utter_despedida_profesional
  
  - rule: Cierre seguro - sin encuesta activa
    condition:
      - slot_was_set:
          - encuesta_activa: false
    steps:
      - action: action_verificar_estado_encuesta
      - action: action_confirmar_cierre_seguro

  - rule: Cierre seguro - encuesta incompleta o activa
    condition:
      - slot_was_set:
          - encuesta_activa: true
    steps:
      - action: action_verificar_estado_encuesta
      - action: action_listen
  
  - rule: Usuario cancela cierre
    steps:
      - intent: cancelar_cierre
      - action: action_cancelar_cierre
      - action: utter_cierre_cancelado
      - action: utter_volver_menu_principal
  
  - rule: Flujo base - cierre seguro
    steps:
      - intent: terminar_conversacion_segura
      - action: action_verificar_estado_encuesta
  
  - rule: Derivar a humano directo (can√≥nica)
    steps:
      - intent: pedir_humano_directo
      - action: action_derivar_y_registrar_humano

  - rule: Usuario insatisfecho - marcar tipo y responder
    steps:
      - intent: respuesta_insatisfecho
      - action: action_set_encuesta_tipo
      - slot_was_set:
          - encuesta_tipo: "negativa"
      - action: utter_encuesta_negativa
      - action: utter_ofrecer_contacto_tutor
  
  - rule: Asignar usuario si no se especifica
    steps:
      - intent: mostrar_token
      - action: action_set_default_tipo_usuario
      - action: action_mostrar_token

  - rule: Usuario niega cierre
    steps:
      - intent: negar_cierre
      - action: action_ir_menu_principal  
  
  - rule: Usuario quiere cerrar solo el chat
    steps:
      - intent: cerrar_chat
      - action: utter_cerrar_chat_confirmacion
  
  - rule: Usuario confirma cierre
    steps:
      - intent: confirmar_cierre
      - action: action_finalizar_conversacion

  - rule: Usuario quiere ver info del estado estudiante
    steps:
      - intent: ver_estado_estudiante_info
      - action: utter_ver_estado_estudiante_info

  - rule: Usuario pide ayuda con certificados
    steps:
      - intent: ayuda_certificados
      - action: utter_ayuda_certificados

  - rule: Usuario elige consultar certificados por identificaci√≥n
    steps:
      - intent: consulta_por_identificacion
      - action: utter_consulta_por_identificacion_info

  - rule: Usuario elige consultar certificados por solicitud
    steps:
      - intent: consulta_por_solicitud
      - action: utter_consulta_por_solicitud_info

  - rule: Usuario elige consultar certificados por tipo
    steps:
      - intent: consulta_por_tipo
      - action: utter_consulta_por_tipo_info

  - rule: Usuario quiere listar tipos de certificados (solo info)
    steps:
      - intent: listar_certificados
      - action: utter_listar_certificados

  - rule: Usuario quiere ver info general de certificados
    steps:
      - intent: ver_certificados_info
      - action: utter_ver_certificados_info

  - rule: Usuario elige certificado de estudio
    steps:
      - intent: certificado_estudio
      - action: utter_certificado_estudio_info

  - rule: Usuario elige certificado de notas
    steps:
      - intent: certificado_notas
      - action: utter_certificado_notas_info

  - rule: Usuario elige certificado laboral
    steps:
      - intent: certificado_laboral
      - action: utter_certificado_laboral_info

  - rule: Usuario elige otro tipo de certificado
    steps:
      - intent: certificado_otro
      - action: utter_certificado_otro_info

  - rule: Usuario quiere descargar certificado
    steps:
      - intent: descargar_certificado
      - action: utter_descargar_certificado
  
  # ==============================
  # üîê Login / ayuda para login
  # ==============================

  - rule: Mostrar gu√≠a de login (deep-links)
    steps:
      - intent: ver_login_hint
      - action: utter_login_hint

  - rule: Usuario quiere iniciar sesi√≥n en Zajuna
    steps:
      - intent: ingreso_zajuna
      - action: action_ingreso_zajuna

  # ==============================
  # üéì CERTIFICADOS
  # ==============================

  - rule: Consultar certificados (autenticado, intent consultar_certificados)
    condition:
      - slot_was_set:
          - is_authenticated: true
    steps:
      - intent: consultar_certificados
      - action: action_ver_certificados

  - rule: Consultar certificados (NO autenticado, intent consultar_certificados)
    condition:
      - slot_was_set:
          - is_authenticated: false
    steps:
      - intent: consultar_certificados
      - action: utter_login_hint

  - rule: Ver certificados (autenticado, intent ver_certificados)
    condition:
      - slot_was_set:
          - is_authenticated: true
    steps:
      - intent: ver_certificados
      - action: action_ver_certificados

  - rule: Ver certificados (NO autenticado, intent ver_certificados)
    condition:
      - slot_was_set:
          - is_authenticated: false
    steps:
      - intent: ver_certificados
      - action: utter_pedir_autenticacion
      - action: utter_login_hint

  - rule: Ver estado estudiante (autenticado)
    condition:
      - slot_was_set:
          - is_authenticated: true
    steps:
      - intent: ver_estado_estudiante
      - action: action_ver_estado_estudiante

  - rule: Ver estado estudiante (NO autenticado)
    condition:
      - slot_was_set:
          - is_authenticated: false
    steps:
      - intent: ver_estado_estudiante
      - action: utter_pedir_autenticacion
      - action: utter_login_hint

  - rule: Sugerir contacto con tutor
    steps:
      - intent: sugerir_tutor
      - action: utter_ofrecer_contacto_tutor
  
  - rule: Sugerencia tutor tras encuesta negativa
    condition:
      - slot_was_set:
          - encuesta_satisfaccion: "negativa"
    steps:
      - action: utter_ofrecer_contacto_tutor
  
  - rule: Analizar emociones del usuario
    steps:
      - intent: detectar_emocion
      - action: action_analizar_estado_usuario

  - rule: Ir a men√∫ acad√©mico
    steps:
      - intent: menu_academico
      - action: utter_menu_academico
      - action: utter_preguntar_tema_academico

  - rule: Soporte - problemas de acceso
    steps:
      - intent: soporte_acceso
      - action: utter_soporte_acceso

  - rule: Soporte - errores en la plataforma
    steps:
      - intent: soporte_error_plataforma
      - action: utter_soporte_error_plataforma 

  - rule: Ver estado del estudiante
    steps:
      - intent: estado_estudiante
      - action: utter_estado_estudiante_resumen

  - rule: Ver contenido del curso
    steps:
      - intent: consultar_contenido_curso
      - action: utter_contenido_curso_resumen
  
  - rule: Ir a men√∫ de soporte (bot√≥n)
    steps:
      - intent: menu_soporte
      - action: utter_menu_soporte

  - rule: Ir a men√∫ administrativo
    steps:
      - intent: menu_administrativo
      - action: utter_menu_administrativo
  
  - rule: Ver tutor asignado (autenticado)
    condition:
      - slot_was_set:
          - is_authenticated: true
    steps:
      - intent: ver_tutor_asignado
      - action: action_tutor_asignado

  - rule: Ver tutor asignado (NO autenticado)
    condition:
      - slot_was_set:
          - is_authenticated: false
    steps:
      - intent: ver_tutor_asignado
      - action: utter_pedir_autenticacion
      - action: utter_login_hint
  
  - rule: Usuario quiere escalar a humano
    steps:
      - intent: pedir_humano
      - action: action_marcar_escalar_humano
      - action: utter_derivar_a_humano_opciones

  - rule: Guardar estado por inactividad
    steps:
      - intent: notificar_inactividad
      - action: action_guardar_estado_seguridad

  - rule: manejar solicitud de certificado
    steps:
      - intent: solicitar_certificado
      - action: utter_info_certificado

  - rule: manejar intent sugerido por LLM para certificado
    condition:
      - slot_was_set:
          - llm_suggested_intent: "solicitar_certificado"
    steps:
      - action: utter_info_certificado
  
  - rule: usar LLM como tutor acad√©mico
    steps:
      - intent: aprender_tema
      - action: action_handle_with_llm

  - rule: Iniciar soporte desde intent principal
    steps:
      - intent: solicitar_soporte
      - action: utter_preguntar_tipo_soporte

  - rule: Soporte como PQRS formal
    steps:
      - intent: soporte_pqrs
      - action: utter_iniciar_soporte_desde_pedir_mensaje
      - action: soporte_form
      - active_loop: soporte_form

  - rule: Soporte como mensaje interno
    steps:
      - intent: soporte_interno
      - action: utter_iniciar_soporte_desde_pedir_mensaje
      - action: soporte_form
      - active_loop: soporte_form

  - rule: Iniciar soporte cuando el usuario pide enviar mensaje
    steps:
      - intent: pedir_mensaje
      - action: utter_iniciar_soporte_desde_pedir_mensaje
      - action: soporte_form
      - active_loop: soporte_form

  - rule: Usuario confirma creaci√≥n de soporte (affirm)
    steps:
      - action: utter_pedir_confirmacion_soporte
      - intent: affirm
      - action: soporte_form
      - active_loop: soporte_form

  - rule: Usuario cancela creaci√≥n de soporte (deny)
    steps:
      - action: utter_pedir_confirmacion_soporte
      - intent: deny
      - action: utter_cancelar_soporte

  - rule: Activar soporte_form cuando el usuario confirma soporte (intent dedicado)
    steps:
      - intent: soporte_confirmar
      - action: soporte_form
      - active_loop: soporte_form

  - rule: Usuario pide que el bot solicite el correo
    steps:
      - intent: pedir_correo
      - action: utter_pedir_correo
      - action: soporte_form
      - active_loop: soporte_form

  - rule: Usuario pide que el bot solicite el email
    steps:
      - intent: pedir_email
      - action: utter_pedir_correo
      - action: soporte_form
      - active_loop: soporte_form

  - rule: Capturar correo expl√≠cito durante soporte_form
    condition:
      - active_loop: soporte_form
    steps:
      - intent: enviar_correo
      - action: soporte_form
      - active_loop: soporte_form

  - rule: Capturar tel√©fono durante soporte_form
    condition:
      - active_loop: soporte_form
    steps:
      - intent: enviar_telefono
      - action: soporte_form
      - active_loop: soporte_form

  - rule: Capturar c√©dula durante soporte_form
    condition:
      - active_loop: soporte_form
    steps:
      - intent: enviar_cedula
      - action: soporte_form
      - active_loop: soporte_form

  - rule: Capturar n√∫mero (c√©dula) durante soporte_form
    condition:
      - active_loop: soporte_form
    steps:
      - intent: enviar_numero
      - action: soporte_form
      - active_loop: soporte_form

  - rule: Submit soporte_form
    condition:
      - active_loop: soporte_form
    steps:
      - action: soporte_form
      - active_loop: null
      - action: action_soporte_submit

  - rule: Terminar conversaci√≥n durante soporte_form
    condition:
      - active_loop: soporte_form
    steps:
      - intent: terminar_conversacion
      - action: action_deactivate_loop
      - active_loop: null

  - rule: Fallback dentro de soporte_form (contar intentos)
    condition:
      - active_loop: soporte_form
    steps:
      - intent: nlu_fallback
      - action: action_registrar_intento_form
      - action: action_verificar_max_intentos_form
      - action: utter_form_fallback_warn
      - action: soporte_form
      - active_loop: soporte_form
  
  - rule: Derivar a humano tras 3 fallos en soporte_form
    condition:
      - active_loop: soporte_form
    steps:
      - slot_was_set:
          - soporte_intentos: 0
      - action: action_deactivate_loop
      - active_loop: null
      - action: utter_handoff_por_fallos
      - action: action_derivar_humano_confirmada

  - rule: Atajo r√°pido ‚Üí Enviar soporte
    steps:
      - intent: enviar_soporte
      - action: action_enviar_soporte
      - action: utter_soporte_creado

  - rule: Enviar soporte directo
    steps:
      - intent: enviar_soporte_directo
      - action: action_enviar_soporte_directo

  - rule: Manejar error en flujo de soporte
    steps:
      - intent: soporte_error
      - action: utter_soporte_error
  
  - rule: Fallback general ‚Üí LLM
    steps:
      - intent: nlu_fallback
      - action: action_handle_with_llm
  
  - rule: Usuario pide ayuda ("fallback" expl√≠cito)
    steps:
      - intent: fallback
      - action: action_handle_with_llm
  
  - rule: Mensaje fuera de dominio ‚Üí LLM
    steps:
      - intent: out_of_scope
      - action: action_handle_with_llm

  - rule: Ir a men√∫ acad√©mico desde consultar_academico
    steps:
      - intent: consultar_academico
      - action: utter_menu_academico
      - action: utter_preguntar_tema_academico