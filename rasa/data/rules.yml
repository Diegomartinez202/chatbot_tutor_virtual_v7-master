version: "3.1"
rules:

  # ---------- Fallback ----------
  - rule: Fallback NLU
    steps:
      - intent: nlu_fallback
      - action: utter_fallback

  # ---------- Sincronizar auth desde metadata ----------
  - rule: Sincronizar auth desde metadata
    steps:
      - action: action_sync_auth_from_metadata

  # ---------- Tutor asignado (con/sin token) ----------
  - rule: Tutor asignado requiere auth
    condition:
      - slot_was_set:
          - has_token: false
    steps:
      - intent: tutor_asignado
      - action: utter_need_auth

  - rule: Tutor asignado con auth
    condition:
      - slot_was_set:
          - has_token: true
    steps:
      - intent: tutor_asignado
      - action: action_tutor_asignado

  # ---------- Estado estudiante (con/sin token) ----------
  - rule: Estado estudiante requiere auth
    condition:
      - slot_was_set:
          - has_token: false
    steps:
      - intent: estado_estudiante
      - action: utter_need_auth

  - rule: Estado estudiante con auth
    condition:
      - slot_was_set:
          - has_token: true
    steps:
      - intent: estado_estudiante
      - action: action_estado_estudiante

  # ---------- Certificados (con/sin token) ----------
  - rule: Ver certificados requiere auth
    condition:
      - slot_was_set:
          - has_token: false
    steps:
      - intent: ver_certificados
      - action: utter_need_auth

  - rule: Ver certificados con auth
    condition:
      - slot_was_set:
          - has_token: true
    steps:
      - intent: ver_certificados
      - action: action_ver_certificados

  # ---------- Ingreso a Zajuna (una sola salida → evita conflicto) ----------
  - rule: Ingreso a Zajuna → instrucciones
    steps:
      - intent: ingreso_zajuna
      - action: utter_ingreso_zajuna_instrucciones

  # ---------- Prompts para limpiar "not used" ----------
  - rule: Pedir nombre -> utter_ask_nombre
    steps:
      - intent: pedir_nombre
      - action: utter_ask_nombre

  - rule: Pedir correo -> utter_ask_email
    steps:
      - intent: pedir_correo
      - action: utter_ask_email

  - rule: Pedir email -> utter_ask_email
    steps:
      - intent: pedir_email
      - action: utter_ask_email

  - rule: Pedir mensaje -> utter_ask_mensaje
    steps:
      - intent: pedir_mensaje
      - action: utter_ask_mensaje

  - rule: Soporte AVA directo
    steps:
      - intent: soporte_ava_directo
      - action: utter_soporte_ava

  - rule: Soporte error directo
    steps:
      - intent: soporte_error
      - action: utter_soporte_error

  - rule: Estado estudiante info (informativo)
    steps:
      - intent: ver_estado_estudiante_info
      - action: utter_estado_estudiante

  - rule: Certificados info (informativo)
    steps:
      - intent: ver_certificados_info
      - action: utter_certificados_info

  # ---------- Soporte form ----------
  - rule: Iniciar soporte_form
    steps:
      - intent: enviar_soporte
      - action: soporte_form
      - active_loop: soporte_form

  - rule: Enviar soporte_form directo
    steps:
      - intent: enviar_soporte_directo
      - action: soporte_form
      - active_loop: soporte_form

  - rule: Confirmar soporte
    steps:
      - intent: soporte_confirmar
      - action: utter_soporte_confirm

  - rule: Submit soporte_form
    condition:
      - active_loop: soporte_form
    steps:
      - action: soporte_form
      - active_loop: null
      - action: action_soporte_submit

  # ---------- Recovery form ----------
  - rule: Iniciar recovery_form (al confirmar)
    steps:
      - intent: confirmar_recuperacion
      - action: recovery_form
      - active_loop: recovery_form

  - rule: Submit recovery_form
    condition:
      - active_loop: recovery_form
    steps:
      - action: recovery_form
      - active_loop: null
      - action: action_submit_recovery
 
  - rule: Ver catálogo directo
    steps:
      - intent: ver_catalogo
      - action: utter_catalogo_cursos
   # ---------- Reglas para marcar uso de utter_* auxiliares ----------
  - rule: Ver catálogo → utter_catalogo_cursos
    steps:
      - intent: ver_catalogo
      - action: utter_catalogo_cursos

  - rule: Ver link soporte → utter_link_soporte
    steps:
      - intent: ver_link_soporte
      - action: utter_link_soporte

  - rule: Ver tarjeta demo → utter_card_ejemplo
    steps:
      - intent: ver_card_demo
      - action: utter_card_ejemplo

  - rule: Ver login hint → utter_login_hint
    steps:
      - intent: ver_login_hint
      - action: utter_login_hint

  - rule: Ver pregunta acceso → utter_preguntar_problema_acceso
    steps:
      - intent: ver_pregunta_acceso
      - action: utter_preguntar_problema_acceso

  - rule: Ver soporte técnico info → utter_soporte_tecnico
    steps:
      - intent: ver_soporte_tecnico_info
      - action: utter_soporte_tecnico

  - rule: Ver confirmar recuperación → utter_confirmar_recuperacion
    steps:
      - intent: ver_confirmar_recuperacion_info
      - action: utter_confirmar_recuperacion

  - rule: Ver error actividad info → utter_error_actividad
    steps:
      - intent: ver_error_actividad_info
      - action: utter_error_actividad

  - rule: Ver tutor asignado info → utter_tutor_asignado
    steps:
      - intent: ver_tutor_asignado_info
      - action: utter_tutor_asignado   
      
  - rule: Login por comando
    steps:
      - intent: auth_login_cmd
      - action: utter_ingreso_zajuna_instrucciones  
  - rule: Ver confirmación de ticket de soporte (demo)
    steps:
      - intent: ver_soporte_creado_info
      - action: utter_soporte_creado
  - rule: Fallback NLU
    steps:
      - intent: nlu_fallback
      - action: utter_fallback
  

  - rule: handle affirm
    steps:
      - intent: affirm
      - action: utter_affirm

  - rule: handle deny
    steps:
      - intent: deny
      - action: utter_deny

  - rule: handle cambiar_idioma_espanol
    steps:
      - intent: cambiar_idioma_espanol
      - action: utter_cambiar_idioma_espanol

  - rule: handle cambiar_idioma_ingles
    steps:
      - intent: cambiar_idioma_ingles
      - action: utter_cambiar_idioma_ingles

  - rule: handle enviar_numero
    steps:
      - intent: enviar_numero
      - action: utter_enviar_numero

  - rule: handle error_actividad
    steps:
      - intent: error_actividad
      - action: utter_error_actividad

  - rule: handle horarios_calendario
    steps:
      - intent: horarios_calendario
      - action: utter_horarios_calendario

  - rule: handle inscribirme
    steps:
      - intent: inscribirme
      - action: utter_inscribirme

  - rule: handle necesita_auth
    steps:
      - intent: necesita_auth
      - action: utter_necesita_auth

  - rule: handle otro_problema_acceso
    steps:
      - intent: otro_problema_acceso
      - action: utter_otro_problema_acceso

  - rule: handle otro_problema_tecnico
    steps:
      - intent: otro_problema_tecnico
      - action: utter_otro_problema_tecnico

  - rule: handle pantalla_blanca
    steps:
      - intent: pantalla_blanca
      - action: utter_pantalla_blanca

  - rule: handle problema_no_ingreso
    steps:
      - intent: problema_no_ingreso
      - action: utter_problema_no_ingreso