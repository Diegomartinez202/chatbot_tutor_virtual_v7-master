version: "3.1"

stories:

# ============================================
# 1️⃣ SOPORTE CONVERSACIONAL + LLM
# ============================================

- story: Soporte general con aclaración LLM
  steps:
    - intent: solicitar_soporte
    - action: utter_preguntar_tipo_soporte
    - action: action_incrementar_turnos_conversacion 
    - intent: soporte_interno
    - action: utter_iniciar_soporte_desde_pedir_mensaje
    - intent: otro_problema_tecnico
    - action: utter_otro_problema_tecnico
    - action: action_handle_with_llm
    - intent: pedir_mensaje
    - action: utter_iniciar_soporte_desde_pedir_mensaje
    - action: utter_ask_email_contacto
    - action: soporte_form
    - active_loop: soporte_form

- story: Soporte técnico directo con LLM
  steps:
    - intent: soporte_tecnico
    - action: utter_soporte_tecnico_menu
    - intent: otro_problema_tecnico
    - action: utter_otro_problema_tecnico
    - action: action_handle_with_llm
    - intent: pedir_mensaje
    - action: utter_iniciar_soporte_desde_pedir_mensaje
    - action: utter_ask_email_contacto
    - action: soporte_form
    - active_loop: soporte_form
  
- story: Soporte pantalla en blanco → ticket
  steps:
    - intent: pantalla_blanca
    - action: utter_pantalla_blanca_ayuda
    - intent: pedir_mensaje
    - action: utter_iniciar_soporte_desde_pedir_mensaje
    - action: utter_ask_email_contacto
    - action: soporte_form
    - active_loop: soporte_form

- story: Error en actividad con explicación LLM
  steps:
    - intent: error_actividad
    - action: utter_error_actividad_ayuda
    - intent: soporte_error
    - action: utter_soporte_error         
    - action: action_handle_with_llm       
    - intent: enviar_soporte_directo
    - action: action_enviar_soporte_directo

- story: Soporte con emoción detectada
  steps:
    - intent: detectar_emocion
    - action: action_analizar_estado_usuario
    - intent: solicitar_soporte
    - action: utter_preguntar_tipo_soporte
    - action: action_incrementar_turnos_conversacion
    - intent: soporte_pqrs
    - action: utter_iniciar_soporte_desde_pedir_mensaje
    - action: utter_ask_email_contacto
    - action: soporte_form
    - active_loop: soporte_form
  
- story: Flujo soporte desde menú principal → PQRS
  steps:
    - intent: solicitar_soporte
    - action: utter_preguntar_tipo_soporte
    - action: action_incrementar_turnos_conversacion
    - intent: soporte_pqrs
    - action: utter_iniciar_soporte_desde_pedir_mensaje
    - action: utter_ask_email_contacto
    - action: soporte_form
    - active_loop: soporte_form

- story: Flujo soporte como mensaje interno
  steps:
    - intent: solicitar_soporte
    - action: utter_preguntar_tipo_soporte
    - action: action_incrementar_turnos_conversacion
    - intent: soporte_interno
    - action: utter_iniciar_soporte_desde_pedir_mensaje
    - intent: pedir_mensaje
    - action: utter_iniciar_soporte_desde_pedir_mensaje
    - action: utter_ask_email_contacto
    - action: soporte_form
    - active_loop: soporte_form
  
- story: Derivar a humano con confirmación (pedir_humano)
  steps:
    - intent: pedir_humano
    - action: action_marcar_escalar_humano
    - action: utter_derivar_a_humano_opciones
    - intent: pedir_humano_directo
    - action: action_derivar_y_registrar_humano
    - action: utter_handoff_iniciado
    - action: utter_derivando_humano
  
- story: Soporte con derivación a humano tras oferta
  steps:
    - intent: escalar_humano
    - action: utter_ofrecer_humano
    - intent: affirm
    - action: action_derivar_y_registrar_humano
    - action: utter_handoff_iniciado
    - action: utter_derivando_humano
    - action: soporte_form
    - active_loop: soporte_form
  
- story: Usuario satisfecho → continuar con otro tema
  steps:
    - intent: respuesta_satisfecho
    - action: action_set_encuesta_tipo
    - action: utter_agradecimiento_satisfaccion
    - action: utter_ofrecer_continuar
    - intent: continuar_tema_si
    - action: utter_continuar_tema_menu
  
# ============================================
# 2️⃣ TUTOR ACADÉMICO + FLUJOS EDUCATIVOS (LLM)
# ============================================

- story: Aprender tema desde menú académico con seguimiento
  steps:
    - intent: menu_academico
    - action: utter_menu_academico
    - action: utter_preguntar_tema_academico
    - intent: aprender_tema
    - action: action_memory_wrapper
    - action: action_handle_with_llm
    - action: action_incrementar_turnos_conversacion 
    - intent: continue
    - action: utter_continuar_tema_menu
    - intent: continuar_tema_si
    - action: utter_continuar_tema_menu

- story: Aprender tema directo con cierre elegante
  steps:
    - intent: aprender_tema
    - action: action_memory_wrapper
    - action: action_handle_with_llm
    - action: action_incrementar_turnos_conversacion
    - intent: continuar_tema_no
    - action: utter_no_continuar_tema
    - action: utter_menu_principal

- story: Ver contenido de curso y profundizar
  steps:
    - intent: consultar_contenido_curso
    - action: utter_contenido_curso_resumen
    - intent: aprender_tema
    - action: action_memory_wrapper
    - action: action_handle_with_llm
    - action: action_incrementar_turnos_conversacion 

- story: Flujo aprender tema con LLM directo
  steps:
    - intent: aprender_tema
    - action: action_memory_wrapper
    - action: action_handle_with_llm
    - action: action_incrementar_turnos_conversacion
  
- story: Flujo tutor académico desde menú académico
  steps:
    - intent: menu_academico
    - action: utter_menu_academico
    - action: utter_preguntar_tema_academico
    - intent: aprender_tema
    - action: action_memory_wrapper
    - action: action_handle_with_llm
    - action: action_incrementar_turnos_conversacion

- story: Encuesta rápida tras problema resuelto
  steps:
    - intent: problema_resuelto_si
    - action: utter_agradecimiento_satisfaccion
    - action: utter_preguntar_satisfaccion
    - intent: respuesta_satisfecho
    - action: action_set_encuesta_tipo
    - action: utter_agradecimiento_satisfaccion
    - action: utter_ofrecer_continuar
  
- story: Emoción negativa → apoyo académico y contacto por correo
  steps:
    - intent: detectar_emocion
    - action: action_analizar_estado_usuario
    - intent: sugerir_tutor
    - action: utter_ofrecer_contacto_tutor
    - intent: contactar_tutor
    - action: utter_contactar_tutor_opciones  

  
- story: Insatisfecho pero seguir con el bot
  steps:
    - intent: respuesta_insatisfecho
    - action: action_set_encuesta_tipo
    - action: utter_encuesta_insatisfaccion
    - action: utter_ofrecer_contacto_tutor
    - intent: continuar_consulta
    - action: utter_menu_principal

- story: Feedback directo con registro
  steps:
    - intent: dar_retroalimentacion
    - action: utter_iniciar_retroalimentacion
    - action: feedback_form
    - active_loop: feedback_form
    - action: feedback_form
    - active_loop: null
    - action: action_guardar_feedback
    - action: utter_gracias_retroalimentacion

- story: Encuesta de satisfacción multi-paso
  steps:
    - intent: iniciar_encuesta
    - action: utter_encuesta_satisfaccion
    - action: action_preguntar_resolucion
    - action: encuesta_satisfaccion_form
    - active_loop: encuesta_satisfaccion_form
    - action: encuesta_satisfaccion_form
    - active_loop: null
    - action: action_registrar_encuesta
    - action: utter_agradecimiento_satisfaccion

- story: Ayuda genérica → LLM + menú
  steps:
    - intent: fallback
    - action: utter_fallback
    - action: action_handle_with_llm
    - intent: ir_menu_principal
    - action: action_ir_menu_principal

- story: Mensaje fuera de dominio con reconducción
  steps:
    - intent: out_of_scope
    - action: utter_out_of_scope
    - action: action_handle_with_llm
    - intent: ir_menu_principal
    - action: action_ir_menu_principal

- story: Fallback en tutor académico
  steps:
    - intent: aprender_tema
    - action: action_memory_wrapper
    - action: action_handle_with_llm
    - action: action_incrementar_turnos_conversacion
    - intent: nlu_fallback
    - action: action_handle_with_llm
    - intent: menu_academico
    - action: utter_menu_academico
    - action: utter_preguntar_tema_academico

- story: Cierre seguro cancelado con retorno al menú
  steps:
    - intent: terminar_conversacion_segura_autosave
    - action: action_verificar_proceso_activo_autosave
    - intent: cancelar_cierre_autosave
    - action: action_cancelar_cierre_autosave
    - action: utter_cierre_cancelado_seguro
    - action: action_ir_menu_principal

- story: Usuario pausa y luego reanuda con Guardian
  steps:
    - intent: guardian_guardar_progreso
    - action: action_guardian_guardar_progreso
    - intent: guardian_pausar_conversacion
    - action: action_guardian_pausar
    - intent: guardian_reanudar_conversacion
    - action: action_guardian_reanudar

- story: Problema no resuelto → LLM y luego decidir
  steps:
    - intent: problema_no_resuelto
    - action: action_handle_with_llm
    - action: utter_problema_resuelto_no
    - action: utter_ofrecer_humano    

- story: Problema no resuelto → aceptar humano
  steps:
    - intent: problema_no_resuelto
    - action: action_handle_with_llm
    - action: utter_problema_resuelto_no
    - action: utter_ofrecer_humano
    - intent: pedir_humano_directo
    - action: action_derivar_y_registrar_humano
    - action: utter_handoff_iniciado
    - action: utter_derivando_humano

- story: Problema no resuelto → continuar con el bot
  steps:
    - intent: problema_no_resuelto
    - action: action_handle_with_llm
    - action: utter_problema_resuelto_no
    - action: utter_ofrecer_humano
    - intent: negar_handoff
    - action: utter_continuar_con_bot
