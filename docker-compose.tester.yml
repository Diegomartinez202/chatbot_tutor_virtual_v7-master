services:
  tester:
    image: python:3.10
    container_name: tester
    working_dir: /app
    volumes:
      - ./:/app
    networks:
      - app-net
    environment:
      PROXY_BASE: "http://nginx-dev:80"
      BACKEND: "http://backend-dev:8000"
      RASA: "http://rasa:5005"

      # Opcional: si tu conftest usa .env
      DOTENV_PATH: ".env.local"
    command:
      - /bin/sh
      - -lc
      - |
        python -m pip install -U pip &&
        python -m pip install \
          pytest pytest-timeout requests pytest-html \
          python-dotenv &&
        mkdir -p reports &&
        python - <<'PY'
        import time, requests
        urls = [
          "http://backend-dev:8000/health",
          "http://rasa:5005/status",
          "http://nginx-dev:80/api/health"
        ]
        for attempt in range(30):
            ok = 0
            for u in urls:
                try:
                    r = requests.get(u, timeout=3)
                    if r.status_code == 200:
                        ok += 1
                except Exception:
                    pass
            if ok == len(urls):
                print("✅ Dependencias arriba")
                break
            print(f"⏳ Esperando servicios... intento {attempt+1}/30")
            time.sleep(2)
        PY
        # Ejecuta exactamente tus tests
        pytest -q tests/test_api.py \
          --disable-warnings --maxfail=1 \
          --html=reports/smoke.html --self-contained-html

networks:
  app-net:
    external: true
    name: tutorbot-local_app-net



