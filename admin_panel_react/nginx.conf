# admin_panel_react/nginx.conf
# Nginx para servir la SPA (Vite build) y proxyear a backend y Rasa dentro del mismo compose.

# Helper para WebSocket
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {
  listen 80;
  server_name _;

  # ---------- Raíz del build de Vite ----------
  root /usr/share/nginx/html;
  index index.html;
  etag on;

  # ---------- Cabeceras de seguridad básicas ----------
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  # Ajusta CSP según necesidades del proyecto. Para SPA básica:
  add_header Content-Security-Policy
    "default-src 'self'; \
     img-src 'self' data: blob:; \
     style-src 'self' 'unsafe-inline'; \
     script-src 'self'; \
     connect-src 'self' http://backend:8000 http://rasa:5005 ws://rasa:5005;" always;

  # ---------- Timeouts razonables ----------
  proxy_connect_timeout   5s;
  proxy_send_timeout      60s;
  proxy_read_timeout      120s;
  send_timeout            60s;

  # ---------- Salud simple (útil para HEALTHCHECK) ----------
  location = /health {
    add_header Content-Type text/plain;
    return 200 "ok\n";
  }

  # ============================================================
  #  Proxy API (REST) → backend:8000
  #  - Con slash al final para preservar la ruta tras /api/
  # ============================================================
  location /api/ {
    proxy_pass http://backend:8000/;
    proxy_http_version 1.1;

    # Cabeceras estándar
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket/stream (por si hay streaming SSE u otros)
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    # CORS mínimo si lo necesitas (descomenta si tu backend no lo maneja)
    # add_header Access-Control-Allow-Origin      "*" always;
    # add_header Access-Control-Allow-Methods     "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
    # add_header Access-Control-Allow-Headers     "Authorization,Content-Type,Accept,Origin,User-Agent" always;
    # if ($request_method = OPTIONS) { return 204; }
  }

  # ============================================================
  #  Rasa HTTP API → rasa:5005
  # ============================================================
  location /rasa/ {
    proxy_pass http://rasa:5005/;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    proxy_read_timeout 120s;
  }

  # ============================================================
  #  Rasa WebSocket → rasa:5005/ws
  # ============================================================
  location /ws/ {
    proxy_pass http://rasa:5005/ws/;
    proxy_http_version 1.1;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 120s;
  }

  # ---------- Cache agresiva para assets con hash ----------
  location ~* \.(?:js|mjs|css|png|jpg|jpeg|gif|svg|ico|webp|woff2?|ttf|eot)$ {
    expires 30d;
    add_header Cache-Control "public, max-age=2592000, immutable";
    try_files $uri =404;
  }

  # ---------- No cache para HTML ----------
  location = /index.html {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    try_files $uri =404;
  }

  # ---------- SPA fallback (React Router) ----------
  location / {
    try_files $uri /index.html;
  }

  # ---------- Gzip básico ----------
  gzip on;
  gzip_min_length 1024;
  gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/json
    application/xml+rss
    image/svg+xml
    font/woff
    font/woff2
    application/font-woff
    application-font-woff2;
}