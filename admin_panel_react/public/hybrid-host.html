<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Host H√≠brido ‚Äì Tutor Virtual</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <<script>
       window.APP_CONTEXT = "hybrid";
       document.documentElement.setAttribute('data-app-context','hybrid');
    </script>
    <!-- La CSP real la controlas desde Nginx; aqu√≠ solo estilos m√≠nimos para la demo -->
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial;
            margin: 0;
            background: #f8fafc;
        }

        header {
            background: #111827;
            color: #fff;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        main {
            padding: 16px;
        }

        .bubble-launch {
            position: fixed;
            right: 18px;
            bottom: 18px;
            z-index: 9998;
            background: #4f46e5;
            color: #fff;
            border: 0;
            border-radius: 999px;
            padding: 12px 14px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(2,6,23,0.18);
        }

        .bubble {
            position: fixed;
            right: 18px;
            bottom: 18px;
            width: 400px;
            max-width: 95vw;
            height: 580px;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(2,6,23,0.18);
            overflow: hidden;
            z-index: 9999;
            display: none;
            flex-direction: column;
        }

            .bubble.open {
                display: flex;
            }

            .bubble .head {
                background: #1f2937;
                color: #fff;
                padding: 8px 10px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                font-size: 14px;
            }

            .bubble .body {
                flex: 1;
            }

        .btn {
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
        }

        .cta {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #4f46e5;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            text-decoration: none;
        }

        .link {
            margin-left: 8px;
            text-decoration: underline;
            color: #1f2937;
        }

        .row {
            margin-top: 12px;
        }

        code {
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <header>
       
        <strong>Portal de prueba (host h√≠brido)</strong>
        <div>
            <a class="cta" href="https://zajuna.sena.edu.co/" target="_blank" rel="noopener noreferrer">üîê Iniciar sesi√≥n</a>
            <a class="link" href="/chat" target="_blank" rel="noopener noreferrer">Abrir chat autenticado</a>
        </div>
    </header>

    <main>
        <h1>Bienvenido</h1>
        <p>Esta p√°gina embeber√° el chat en modo invitado y pedir√° token solo cuando una acci√≥n lo requiera.</p>

        <div class="row">
            <button id="btn-set-token" class="btn">Simular guardar token en localStorage</button>
            <button id="btn-clear-token" class="btn">Borrar token</button>
        </div>
        <div class="row">
            <small>Token actual: <code id="token-view">(sin token)</code></small>
        </div>
    </main>

    <button id="launcher" class="bubble-launch">üí¨ Abrir chat</button>

    <div id="bubble" class="bubble" aria-live="polite">
        <div class="head">
            <div><strong>Tutor Virtual</strong></div>
            <div>
                <button id="minimize" class="btn" type="button">Minimizar</button>
                <button id="close" class="btn" type="button">Cerrar</button>
            </div>
        </div>
        <div class="body">
            <iframe id="chatFrame"
                    src="/chat?embed=1&guest=1"
                    title="Chat Zajuna"
                    referrerpolicy="strict-origin-when-cross-origin"
                    allow="microphone; clipboard-read; clipboard-write"
                    style="border:0;width:100%;height:100%;display:block"></iframe>
        </div>
    </div>

    <script>
      
        const frame = document.getElementById("chatFrame");
        const bubble = document.getElementById("bubble");
        const launcher = document.getElementById("launcher");
        const btnClose = document.getElementById("close");
        const btnMin = document.getElementById("minimize");
        const tokenView = document.getElementById("token-view");
        const btnSet = document.getElementById("btn-set-token");
        const btnClear = document.getElementById("btn-clear-token");

        const ALLOWED_IFRAME_ORIGINS = [
            location.origin,               // http://localhost:8080 (host en tu Nginx)
            "https://zajuna.sena.edu.co",  
            "http://localhost:5173"       
        ];

        function getToken() {
            try { return localStorage.getItem("host_token") || localStorage.getItem("zajuna_token") || null; } catch { return null; }
        }
        function renderToken() {
            const t = getToken();
            tokenView.textContent = t ? t : "(sin token)";
        }
        function postToIframe(msg) {
            try { frame.contentWindow?.postMessage(msg, "*"); } catch { }
        }
     
        function sendAuthToken() {
            const tok = getToken();
            if (tok) postToIframe({ type: "auth:token", token: tok });
        }

        window.addEventListener("message", (ev) => {
            const origin = ev.origin || ev.originalEvent?.origin;
            if (ALLOWED_IFRAME_ORIGINS.length && !ALLOWED_IFRAME_ORIGINS.includes(origin)) return;

            const data = ev.data || {};
            if (!data || typeof data !== "object") return;

            if (data.type === "auth:request") sendAuthToken();

            if (data.type === "widget:toggle") {
                if (data.action === "close") bubble.classList.remove("open");
                else bubble.classList.toggle("open");
            }
        });

        launcher.addEventListener("click", () => {
            bubble.classList.add("open");
            sendAuthToken(); // al abrir, empuja token si ya hay
        });
        btnClose.addEventListener("click", () => bubble.classList.remove("open"));
        btnMin.addEventListener("click", () => {
            bubble.style.height = (bubble.style.height === "56px" ? "580px" : "56px");
        });

        // Simuladores de token (para demo)
        btnSet.addEventListener("click", () => {
            const sample = "demo-token-" + Math.random().toString(36).slice(2, 8);
            try { localStorage.setItem("host_token", sample); } catch { }
            renderToken();
            sendAuthToken();
        });
        btnClear.addEventListener("click", () => {
            try { localStorage.removeItem("host_token"); } catch { }
            renderToken();
        });

        // Al cargar
        renderToken();
        frame.addEventListener("load", () => sendAuthToken());
    </script>
</body>
</html>
