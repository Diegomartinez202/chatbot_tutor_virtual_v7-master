Embed Guide ‚Äî Chatbot Tutor Virtual (texto plano)

Este documento explica c√≥mo incrustar el chat en sitios externos con el launcher (bot√≥n flotante) y la p√°gina chat-embed.html.
Incluye snippets en versi√≥n segura (entidades HTML) para evitar que tu editor/IDE los interprete como JSX/JS/HTML.

Archivos relevantes (frontend)

public/chat-widget.js ‚Üí launcher p√∫blico (bot√≥n flotante + panel con iframe).

public/chat-embed.html ‚Üí contenedor can√≥nico del chat (iframe ‚Üí /chat?embed=1).

public/bot-avatar.png, public/bot-loading.png, public/favicon.ico, public/site.webmanifest.

Variables de entorno (frontend)

Transporte:

VITE_CHAT_TRANSPORT=rest o ws

VITE_RASA_WS_URL=wss://tu-servidor-de-rasa/ws (si usas WS)

VITE_CHAT_REST_URL=/api/chat (proxy REST a backend)

Seguridad postMessage:

VITE_ALLOWED_HOST_ORIGINS=https://app.zajuna.edu,http://localhost:5173

Avatares:

VITE_BOT_AVATAR=/bot-avatar.png

VITE_USER_AVATAR=/user-avatar.png (opcional)

Backend (resumen ya integrado)

/chat-embed.html y assets se redirigen al dominio del frontend (FRONTEND_SITE_URL).

CSP/iframe: usa FRAME_ANCESTORS, EMBED_ALLOWED_ORIGINS, FRONTEND_SITE_URL, EMBED_ENABLED=true.

CORS: ALLOWED_ORIGINS debe incluir los dominios que incrustan el widget.

1) Launcher (bot√≥n flotante) ‚Äî snippet seguro (entidades HTML)

Entre [INICIO] y [FIN] est√° el snippet ‚Äúseguro‚Äù.
Para usarlo en producci√≥n, reemplaza &lt; por < y &gt; por >.

[INICIO]
<script src="/chat-widget.js"
        ¬†¬†data-chat-url="/chat-embed.html?src=%2Fchat%3Fembed%3D1"
        ¬†¬†data-avatar="/bot-avatar.png"
        ¬†¬†data-title="Abrir chat"
        ¬†¬†data-position="bottom-right"
        ¬†¬†data-panel-width="380px"
        ¬†¬†data-panel-height="560px"
        ¬†¬†data-allowed-origins="https://tu-sitio.com,https://app.zajuna.edu"
        ¬†¬†data-login-url="https://zajuna.edu/login"
        ¬†¬†data-badge="auto"
        ¬†¬†defer></script>
[FIN]

Notas:

data-allowed-origins debe contener el origin de la p√°gina donde corre el iframe (y el del panel, si es otro).

data-login-url permite redirigir a SSO si no hay token.

data-badge="auto" activa el contador de mensajes no le√≠dos.

2) Embed directo (iframe) ‚Äî snippet seguro (entidades HTML)

[INICIO]
<iframe ¬†¬†src="/chat-embed.html?src=%2Fchat%3Fembed%3D1&w=380px&h=560px"
        ¬†¬†title="Chatbot"
        ¬†¬†allow="clipboard-write"
        ¬†¬†referrerpolicy="no-referrer"
        ¬†¬†sandbox="allow-scripts allow-forms allow-same-origin allow-popups"
        ¬†¬†style="width:380px;height:560px;border:0;border-radius:16px;overflow:hidden">
</iframe>
[FIN]

3) Handshake de autenticaci√≥n (c√≥mo funciona)

El iframe del chat env√≠a: postMessage({ type: "auth:needed" }) al host.

El launcher intenta resolver un token (ej.: window.getZajunaToken() o localStorage.zajuna_token) y responde: postMessage({ type: "auth:token", token }).

Si no hay token y est√° definido data-login-url, el launcher redirige a esa URL (con ?redirect=<url-actual>
    ).

    Requisitos:

    VITE_ALLOWED_HOST_ORIGINS en el frontend y CSP/iframe en el backend deben incluir tu dominio anfitri√≥n.

    El backend acepta Authorization: Bearer <token>
    en /api/chat.

    4) Transporte (REST / WebSocket)

    REST (default):
    VITE_CHAT_TRANSPORT=rest
    VITE_CHAT_REST_URL=/api/chat

    WS:
    VITE_CHAT_TRANSPORT=ws
    VITE_RASA_WS_URL=wss://tu-servidor-de-rasa/ws

    El ChatUI y el launcher seleccionan transporte por VITE_CHAT_TRANSPORT.

    5) Smoke test (r√°pido)

    Dev: npm run dev ‚Üí abre http://localhost:5173/chat (env√≠a un mensaje).

    Embed: http://localhost:5173/chat-embed.html?src=/chat%3Fembed%3D1.

    Launcher externo: pega el snippet del punto 1 en una p√°gina simple y verifica:

    Aparece el bot√≥n.

    Al clic se abre el panel con el iframe.

    El badge cuenta no le√≠dos si usas data-badge="auto".

    6) Problemas comunes (y soluci√≥n)

    El editor muestra errores tipo JSX/TSX: est√°s visualizando snippets como c√≥digo. Usa estos snippets con entidades HTML (no son c√≥digo).

    No carga el iframe: revisa CSP ‚Üí FRAME_ANCESTORS / EMBED_ALLOWED_ORIGINS.

    401/403 al enviar mensajes**: el host debe pasar auth:token o permitir modo an√≥nimo.

    No aparece badge: usa data-badge="auto" y aseg√∫rate de que el postMessage llegue al launcher (or√≠genes permitidos correctos).

    7) Tabla de atributos del launcher (chat-widget.js)
    Atributo	Tipo	Default	Descripci√≥n
    data-chat-url	string	/chat-embed.html?src=%2Fchat%3Fembed%3D1	URL del embed a cargar en el panel.
    data-avatar	string	/bot-avatar.png	Imagen del bot√≥n flotante.
    data-title	string	Abrir chat	Texto accesible/tooltip del bot√≥n.
    data-position	string	bottom-right	bottom-right o bottom-left.
    data-size	number	64	Tama√±o (px) del bot√≥n.
    data-offset	number	24	Separaci√≥n al borde (px).
    data-z-index	number	2147483600	Z-index del launcher.
    data-panel-width	string	380px	Ancho del panel.
    data-panel-height	string	560px	Alto del panel.
    data-overlay	boolean	true	Fondo semitransparente al abrir.
    data-close-on-esc	boolean	true	Cerrar con tecla Escape.
    data-iframe-title	string	Chat	Atributo title del iframe.
    data-allow	string	clipboard-write	allow del iframe.
    data-sandbox	string	allow-scripts allow-forms allow-same-origin allow-popups	Sandbox del iframe.
    data-allowed-origins	csv	[] (usa origin del iframe si vac√≠o)	Or√≠genes autorizados para postMessage.
    data-login-url	string	""	URL de login (SSO) si falta token.
    data-badge	string/num	""	"" (off), "auto" (no le√≠dos), o n√∫mero fijo.
    data-autoinit	boolean	true	Monta autom√°ticamente al cargar el script.
    8) Checklist producci√≥n

    FRAME_ANCESTORS y EMBED_ALLOWED_ORIGINS incluyen dominios externos.

    ALLOWED_ORIGINS (CORS) permite llamadas desde panel/launcher.

    FRONTEND_SITE_URL apunta al panel (redir de /chat-embed.html y assets).

    .env frontend con transporte correcto (rest/ws) y URLs v√°lidas.

    Handshake de login probado (token ‚Üí backend).

    Tests E2E pasando (local y/o CI).

    9) D√≥nde ubicar esta gu√≠a

    Gu√°rdala como EMBED_GUIDE.md en la ra√≠z del repo.
    Enl√°zala desde tu README.md principal con: ‚ÄúVer EMBED_GUIDE.md para integrar el widget‚Äù.

    10) Convertir los snippets a HTML real

    Si necesitas las etiquetas reales, pega el snippet en tu editor y reemplaza:

    &lt; ‚Üí <

    &gt; ‚Üí >

    (La raz√≥n de usar entidades aqu√≠ es evitar que tu editor/IDE lo trate como c√≥digo y muestre warnings/errores.)
    üì∏ Capturas de ejemplo (opcional, recomendado)

    D√≥nde guardarlas: crea la carpeta docs/embed/ en la ra√≠z del repo y coloca all√≠ las im√°genes.
    C√≥mo referenciarlas en el README/gu√≠as: usa rutas relativas en Markdown:

    ![Launcher (cerrado)](docs/embed/launcher-closed.png)
    ![Panel (abierto)](docs/embed/launcher-open.png)
    ![Embed standalone](docs/embed/embed-standalone.png)
    ![Vista m√≥vil](docs/embed/mobile.png)
    ![SSO/redirect](docs/embed/sso-redirect.png)

    Lista sugerida de capturas (nombres propuestos):

    launcher-closed.png ‚Äî bot√≥n flotante en la esquina (desktop).

    launcher-open.png ‚Äî panel abierto mostrando el iframe.

    embed-standalone.png ‚Äî p√°gina con chat-embed.html funcionando (sin launcher).

    mobile.png ‚Äî ejemplo responsivo en viewport ~375px.

    badge.png ‚Äî contador de no le√≠dos activo (data-badge="auto").

    sso-redirect.png ‚Äî pantalla justo antes/despu√©s del login (si usas data-login-url).

    Tip: si ya tienes Playwright, puedes generar capturas con page.screenshot({ path: 'docs/embed/launcher-open.png' }) al final de tus tests E2E.

    üîß Par√°metros de chat-embed.html (query string)

    chat-embed.html acepta algunos par√°metros de query. Adem√°s, reenv√≠a (forward) ciertos par√°metros al iframe interno (el /chat?embed=1) para que el backend/proxy los reciba.

    Par√°metro	Tipo	Default	Ejemplo	¬øSe reenv√≠a al iframe interno?	Descripci√≥n
    src	string (URL o ruta)	/chat?embed=1	/chat%3Fembed%3D1	S√≠ (como parte del src final)	De d√≥nde cargar el chat interno. Acepta absoluto o relativo. Si omites, usa el chat interno est√°ndar.
    w	string (CSS)	380px	400px	No	Ancho visual del contenedor embebido (wrapper). No afecta al contenido interno, solo al marco.
    h	string (CSS)	560px	70vh	No	Alto visual del contenedor embebido.
    api	string (URL base)	‚Äî	https://backend.tuapp.com/api	S√≠	Base de API/Proxy que usa el chat interno (si lo soportas).
    user_id	string	‚Äî	alumno-123	S√≠	Identificador del usuario (si decides manejar sesiones an√≥nimas o tracking).
    avatar	string (URL)	‚Äî	/bot-avatar.png	S√≠	Avatar del bot para el UI/iframe, si el internal lo soporta.

    Nota: En la implementaci√≥n actual, se reenv√≠an expl√≠citamente estos keys: api, user_id, avatar.
    src, w, h se consumen en el wrapper: src para construir la URL final del iframe; w/h solo ajustan el tama√±o del marco.

    Ejemplos listos (con entidades HTML)

    Embed b√°sico (usa el chat interno):

    &lt;iframe
    src="/chat-embed.html?src=%2Fchat%3Fembed%3D1&amp;w=380px&amp;h=560px"
    title="Chatbot"
    allow="clipboard-write"
    referrerpolicy="no-referrer"
    sandbox="allow-scripts allow-forms allow-same-origin allow-popups"
    style="width:380px;height:560px;border:0;border-radius:16px;overflow:hidden"&gt;
    &lt;/iframe&gt;


    Embed con reenv√≠o de api y user_id:

    &lt;iframe
    src="/chat-embed.html?src=%2Fchat%3Fembed%3D1&amp;api=https%3A%2F%2Fbackend.tuapp.com%2Fapi&amp;user_id=alumno-123"
    title="Chatbot"
    allow="clipboard-write"
    referrerpolicy="no-referrer"
    sandbox="allow-scripts allow-forms allow-same-origin allow-popups"
    style="width:380px;height:560px;border:0;border-radius:16px;overflow:hidden"&gt;
    &lt;/iframe&gt;


    Embed ancho/alto personalizados (viewport units):

    &lt;iframe
    src="/chat-embed.html?src=%2Fchat%3Fembed%3D1&amp;w=92vw&amp;h=70vh"
    title="Chatbot"
    allow="clipboard-write"
    referrerpolicy="no-referrer"
    sandbox="allow-scripts allow-forms allow-same-origin allow-popups"
    style="width:92vw;height:70vh;border:0;border-radius:16px;overflow:hidden"&gt;
    &lt;/iframe&gt;

    FAQ de tama√±os

    w/h aplican al wrapper externo del embed.

    Si el contenido interno necesita layout responsivo, maneja breakpoints dentro de tu app del chat.

    En m√≥viles, puedes preferir w=94vw y h=70vh.

    Notas de seguridad

    Mant√©n referrerpolicy="no-referrer" y un sandbox estricto (allow-scripts allow-forms allow-same-origin allow-popups).

    Verifica que los dominios que hospedan el embed est√©n en:

    FRAME_ANCESTORS / EMBED_ALLOWED_ORIGINS (backend ‚Üí CSP/iframe)

    ALLOWED_ORIGINS (backend ‚Üí CORS, para llamadas REST)

    VITE_ALLOWED_HOST_ORIGINS (frontend ‚Üí postMessage seguro)
