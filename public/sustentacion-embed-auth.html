<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Sustentación • Chatbot Tutor Virtual (Embed + Auth)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            margin: 0;
            padding: 24px;
            background: #f8fafc;
        }

        h1 {
            margin-top: 0;
        }

        .desc {
            color: #475569;
            margin-bottom: 16px;
        }

        .frame {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
        }
    </style>
</head>
<body>
    <h1>Demo de Sustentación — Chatbot Tutor Virtual (Auth)</h1>
    <p class="desc">El iframe pide token con <code>auth:needed</code>. Este parent responde con <code>auth:token</code>.</p>

    <div class="frame" style="height:640px">
        <iframe id="chat_iframe"
                src="http://localhost:5173/chat?embed=1"
                style="width:100%; height:100%; border:0;"
                allow="microphone; clipboard-read; clipboard-write"
                referrerpolicy="strict-origin-when-cross-origin"
                sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-downloads allow-modals"></iframe>
    </div>

    <script>
    const FRAME_ORIGIN = "http://localhost:5173";
    function getAuthToken() {
      // DEMO: el backend acepta FAKE_TOKEN_ZAJUNA si DEMO_MODE=true
      return "FAKE_TOKEN_ZAJUNA";
      // Producción: retorna JWT real (SSO/OIDC).
    }
    window.addEventListener("message", (ev) => {
      if (ev.origin !== FRAME_ORIGIN) return;
      if (ev.data?.type === "auth:needed") {
        const token = getAuthToken();
        document.getElementById("chat_iframe")
          .contentWindow?.postMessage({ type: "auth:token", token }, FRAME_ORIGIN);
      }
    });
    // Opcional: enviar token proactivo al cargar
    window.addEventListener("load", () => {
      setTimeout(() => {
        document.getElementById("chat_iframe")
          .contentWindow?.postMessage({ type: "auth:token", token: getAuthToken() }, FRAME_ORIGIN);
      }, 300);
    });
    </script>
</body>
</html>
