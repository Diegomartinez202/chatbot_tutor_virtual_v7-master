<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Chatbot Embebed Tutor Virtual – Sustentación</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bubble styles (mínimos) -->
    <link rel="stylesheet" href="./zajuna-bubble.css" />
    <style>
        /* Estilos de la página demo */
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            background: #0f172a;
            color: #e5e7eb;
            padding: 24px;
        }

        .demo-card {
            max-width: 920px;
            margin: 0 auto;
            background: #111827;
            border-radius: 14px;
            padding: 24px;
            border: 1px solid #374151;
            box-shadow: 0 10px 25px rgba(0,0,0,.35);
        }

            .demo-card h1 {
                margin: 0 0 8px;
                font-size: 22px
            }

            .demo-card p {
                margin: 8px 0;
                color: #cbd5e1
            }

        .demo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 16px
        }

        .demo-panel {
            background: #0b1220;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px
        }

            .demo-panel h2 {
                margin: 0 0 8px;
                font-size: 16px
            }

            .demo-panel code, .demo-panel pre {
                color: #d1fae5
            }

        .small {
            font-size: 12px;
            color: #9ca3af
        }

        .btn {
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 10px;
            background: #4f46e5;
            color: white;
            border: 0;
        }

            .btn.secondary {
                background: #1f2937;
                border: 1px solid #374151;
            }

        .pill {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            padding: 4px 10px;
            border: 1px solid #334155;
            border-radius: 999px;
            background: #0b1220;
        }
    </style>
</head>
<body>
    <div class="demo-card">
        <h1>Chatbot Embebed Tutor Virtual – <em>Sustentación</em></h1>
        <p>
            Este demo muestra el <strong>widget burbuja</strong> embebido con dos modos:
            <strong>sin autenticación</strong> (habla con Rasa directo) y
            <strong>con autenticación Zajuna</strong> (token Bearer opcional enviado por <code>postMessage</code>).
        </p>

        <div class="pill">
            <span>Estado tema/idioma (último del iframe)</span>
            <span id="pref-pill" class="small">—</span>
        </div>

        <div class="demo-grid">
            <div class="demo-panel">
                <h2>1) Sin autenticación (Rasa directo)</h2>
                <p>El iframe del chatbot se carga con el transport <code>rest</code> y se comunica con Rasa sin bearer token.</p>
                <button class="btn" id="btn-load-unauth">Cargar burbuja sin auth</button>
                <p class="small">Al cargar, aparecerá la burbuja abajo a la derecha.</p>
            </div>

            <div class="demo-panel">
                <h2>2) Con autenticación Zajuna (token vía postMessage)</h2>
                <p>
                    Carga el widget y luego envíale un token <code>Bearer</code> simulado.
                    En producción, el token vendrá de tu sesión real.
                </p>
                <button class="btn" id="btn-load-auth">Cargar burbuja con auth</button>
                <button class="btn secondary" id="btn-send-token" disabled>Enviar token simulado</button>
                <p class="small">Tip: el backend valida el token si está habilitado; en modo demo puedes aceptar <code>FAKE_TOKEN_ZAJUNA</code>.</p>
            </div>
        </div>

        <div class="demo-panel" style="margin-top: 16px">
            <h2>Telemetría de eventos</h2>
            <p>El iframe emite <code>postMessage</code> hacia el host:</p>
            <ul class="small">
                <li><code>{ type: "telemetry", event: "message_sent" }</code></li>
                <li><code>{ type: "telemetry", event: "message_received" }</code></li>
                <li><code>{ type: "prefs:update", prefs: { theme, language } }</code> — cuando el usuario cambia tema/idioma en el panel de configuración del iframe</li>
            </ul>
            <pre id="log" style="background:#0b1220; padding:10px; border-radius:8px; max-height:200px; overflow:auto;">[log]</pre>
        </div>
    </div>

    <!-- Bubble loader -->
    <script src="./zajuna-bubble.js"></script>
    <script>
    // Config del host (dominio permitido del iframe)
    // Ajusta ALLOWED_IFRAME_ORIGIN a tu frontend donde corre el chatbot embebido:
    // Ej: http://localhost:5173 (si tu iframe sale del mismo vite)
    // o la URL donde sirves el "standalone" del chatbot (otra puerta).
    const ALLOWED_IFRAME_ORIGIN = window.location.origin;

    // Ruta del iframe de chatbot — debe renderizar ChatUI con props embed=true (tu app ya lo soporta).
    // Si usas una ruta dedicada como /embed/chat o /app?embed=true, ajústala aquí.
    const CHATBOT_IFRAME_URL = `${ALLOWED_IFRAME_ORIGIN}/?embed=1`;

    // 1) Inicializa la burbuja con config mínima
    const bubble = window.ZajunaBubble?.create({
      iframeUrl: CHATBOT_IFRAME_URL,
      allowedOrigin: ALLOWED_IFRAME_ORIGIN, // seguridad postMessage
      title: "Tutor Virtual",
      subtitle: "Sustentación",
      position: "bottom-right",
      theme: "auto", // auto | light | dark
      startOpen: false, // comienza como pill/burbuja
    });

    // 2) Botones demo
    const btnUnauth = document.getElementById("btn-load-unauth");
    const btnAuth = document.getElementById("btn-load-auth");
    const btnSendToken = document.getElementById("btn-send-token");
    const pill = document.getElementById("pref-pill");
    const $log = document.getElementById("log");

    function log(msg) {
      const ts = new Date().toISOString().replace('T',' ').replace('Z','');
      $log.textContent += `\n[${ts}] ${msg}`;
      $log.scrollTop = $log.scrollHeight;
    }

    // Modo sin autenticación: solo aseguramos burbuja creada y abierta
    btnUnauth.addEventListener("click", () => {
      bubble?.mount();
      bubble?.open();
      log("Burbuja cargada (sin auth).");
    });

    // Modo con autenticación: montamos y dejamos botón de token activo
    btnAuth.addEventListener("click", () => {
      bubble?.mount();
      bubble?.open();
      btnSendToken.disabled = false;
      log("Burbuja cargada. Listo para enviar token.");
    });

    // Envía token simulado al iframe
    btnSendToken.addEventListener("click", () => {
      bubble?.sendAuthToken("FAKE_TOKEN_ZAJUNA");
      log("Token simulado enviado a iframe.");
    });

    // 3) Escucha eventos del iframe (telemetría + prefs)
    bubble?.onEvent((evt) => {
      if (evt?.type === "telemetry") {
        log(`telemetry: ${evt.event}`);
      } else if (evt?.type === "prefs:update") {
        const theme = evt?.prefs?.theme || "light";
        const lang = evt?.prefs?.language || "es";
        pill.textContent = `theme=${theme} · lang=${lang}`;
        log(`prefs:update → theme=${theme}, language=${lang}`);
        // Si quieres sincronizar tema del host con el iframe:
        // document.documentElement.classList.toggle('dark', theme === 'dark')
      } else if (evt?.type === "auth:needed") {
        log("El iframe solicitó autenticación (auth:needed).");
      }
    });
    </script>
</body>
</html>
