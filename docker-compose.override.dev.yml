# docker-compose.override.dev.yml
# Actívalo con:
#   docker compose -f docker-compose.yml -f docker-compose.override.dev.yml --profile build up -d --build

services:
  backend:
    profiles: ["build"]
    command: >
      sh -lc "exec uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000"
    restart: unless-stopped
    environment:
      ALLOWED_ORIGINS: "http://localhost:5173,http://localhost:8080"
      EMBED_ALLOWED_ORIGINS: "http://localhost:8080,http://localhost:5173"
      FRAME_ANCESTORS: "'self' http://localhost:8080 http://localhost:5173"
      DEMO_MODE: "true"
      CHAT_REQUIRE_AUTH: "false"

  admin:
    profiles: ["build"]
    command: >
      sh -lc "npm install && npm run dev -- --host --port 5173"
    restart: unless-stopped
    environment:
      VITE_ALLOWED_HOST_ORIGINS: "http://localhost:8080,http://localhost:5173"
      VITE_USER_SETTINGS_URL: "/api/me/settings"

  rasa:
    profiles: ["build"]
    environment:
      SQLALCHEMY_SILENCE_UBER_WARNING: "1"
      SQLALCHEMY_WARN_20: "0"

  action-server:
    profiles: ["build"]

  # ⬇️ Nginx de DEV ve TODA la conf: dev/, common/, etc.
  nginx-dev:
    profiles: ["build"]
    image: nginx:alpine
    container_name: nginx-dev
    restart: unless-stopped
    depends_on:
      - backend-dev
      - admin-dev
      - rasa
    ports:
      - "8080:80"
    volumes:
      - ./ops/nginx/conf.d:/etc/nginx/conf.d:ro
    environment:
      APP_ENV: development
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1/rasa/status"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s
