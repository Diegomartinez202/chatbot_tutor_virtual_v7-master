# ops/nginx/conf.d/app.conf

# ===== Upstreams (build + prod) =====
# En PROD: 'backend', 'admin' existen.
# En BUILD: 'backend-dev', 'admin-dev' existen.
upstream backend_up {
  server backend-dev:8000 max_fails=3 fail_timeout=5s;   # <— usa backend-dev
}

upstream admin_up {
  server admin-dev:5173 max_fails=3 fail_timeout=5s;     # <— usa admin-dev
}
upstream rasa_up {
  server rasa:5005 max_fails=3 fail_timeout=5s;
}

# WebSocket helpers
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {
  listen 80;
  server_name _;

  # --- Límites y compresión ---
  client_max_body_size 50m;
  gzip on;
  gzip_min_length 1024;
  gzip_types text/plain text/css application/json application/javascript application/xml+rss image/svg+xml;

  # --- Timeouts razonables para chat/streaming ---
  proxy_connect_timeout   5s;
  proxy_send_timeout      60s;
  proxy_read_timeout      120s;
  send_timeout            60s;

  # --- Cabeceras de seguridad básicas (ajusta según políticas) ---
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

  # =======================================
  #  /  → Admin (SPA o Vite en modo build)
  # =======================================
  location / {
    proxy_pass http://admin_up;
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # HMR/WebSocket (Vite en build)
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    # CSP básica para SPA; ajusta dominios/recursos si lo necesitas
    add_header Content-Security-Policy
      "default-src 'self'; \
       frame-ancestors 'self'; \
       img-src 'self' data: blob:; \
       style-src 'self' 'unsafe-inline'; \
       script-src 'self'; \
       connect-src 'self' http://backend:8000 http://rasa:5005 ws://rasa:5005;"
      always;
  }

  # ===========================
  #  /api → FastAPI (backend)
  # ===========================
  location /api/ {
    # Preflight CORS simple (ajusta orígenes si usas dominios)
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin      $http_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Access-Control-Allow-Methods     "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
      add_header Access-Control-Allow-Headers     "Authorization,Content-Type,Accept,Origin,User-Agent" always;
      return 204;
    }
    add_header Access-Control-Allow-Origin      $http_origin always;
    add_header Access-Control-Allow-Credentials "true" always;

    # CSP estricta en API
    add_header Content-Security-Policy
      "default-src 'none'; \
       frame-ancestors 'self'; \
       connect-src 'self' http://backend:8000 http://rasa:5005; \
       img-src 'self' data: blob:; \
       style-src 'self' 'unsafe-inline'; \
       script-src 'self';"
      always;

    proxy_pass http://backend_up/;   # ← mantener el slash final
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;
  }

  # ===========================
  #  /rasa → HTTP API Rasa
  # ===========================
  location /rasa/ {
    proxy_pass http://rasa_up/;
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;
    proxy_read_timeout 120s;
  }

  # ==================================
  #  /ws → WebSocket directo a Rasa
  # ==================================
  location /ws {
    proxy_pass http://rasa_up/ws;
    proxy_http_version 1.1;
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 120s;
  }
}