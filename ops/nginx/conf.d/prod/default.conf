# ---------- Upstreams (DNS de Docker: nombres de servicio) ----------
upstream backend_upstream {
    server backend:8000;
    keepalive 32;
}

upstream rasa_upstream {
    server rasa:5005;
    keepalive 16;
}

# ---------- Mapa para WebSocket ----------
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
  listen 80 default_server;
  server_name _;

  root  /usr/share/nginx/html;
  index index.html;
  etag on;

  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  client_max_body_size 20m;

  # ⚠️ Estas cabeceras son para HTML. El API NO las hereda (ver /api/ más abajo)
  add_header Permissions-Policy "autoplay=(), clipboard-write=(), microphone=(), camera=()" always;

  add_header Content-Security-Policy "default-src 'self';
    script-src 'self' 'unsafe-inline';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    media-src 'self' https:;
    connect-src 'self' https: http: ws: wss:;
    frame-src 'self';
    frame-ancestors 'self' https://zajuna.sena.edu.co http://localhost:8080 http://localhost:5173;
    upgrade-insecure-requests" always;

  # Ping simple
  location = /ping {
    add_header Content-Type text/plain;
    return 200 "ok\n";
  }

  # Avatar del usuario (evita 404 si lo usas sin subir uno)
  location = /user-avatar.png {
    try_files /embed/user-avatar.png /user-avatar.png =404;
  }

  # ========= API (FastAPI) =========
  # BLOQUE ESPECÍFICO PARA RASA DENTRO DE /api/  (debe ir ANTES que el /api/ genérico)
  location ^~ /api/chat/rasa/ {
    proxy_pass         http://rasa_upstream/;    # ← Rasa directo
    proxy_http_version 1.1;

    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    proxy_set_header   Upgrade           $http_upgrade;
    proxy_set_header   Connection        $connection_upgrade;

    proxy_read_timeout    300s;
    proxy_send_timeout    300s;
    client_max_body_size  25m;

    # CORS para el endpoint de Rasa vía /api
    add_header 'Access-Control-Allow-Origin'      $http_origin    always;
    add_header 'Vary'                             'Origin'        always;
    add_header 'Access-Control-Allow-Credentials' 'true'          always;
    add_header 'Access-Control-Allow-Methods'     'GET,POST,PUT,PATCH,DELETE,OPTIONS' always;
    add_header 'Access-Control-Allow-Headers'     'Authorization,Content-Type,X-Requested-With' always;
    add_header 'Access-Control-Expose-Headers'    'Content-Length,Content-Type,X-Request-Id' always;
    if ($request_method = OPTIONS) { return 204; }

    # El API de Rasa devuelve JSON/streams: no heredar cabeceras HTML
    proxy_hide_header Content-Security-Policy;
    proxy_hide_header Permissions-Policy;

    proxy_buffering off;   # útil para SSE/stream
  }

  # /api/ genérico → Backend (FastAPI)
  location /api/ {
    proxy_pass         http://backend_upstream/;
    proxy_http_version 1.1;

    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    # WebSocket / Upgrade (sin 'map' dentro del location)
    set $connection_upgrade close;
    if ($http_upgrade != "") { set $connection_upgrade upgrade; }
    proxy_set_header   Upgrade           $http_upgrade;
    proxy_set_header   Connection        $connection_upgrade;

    proxy_read_timeout    300s;
    proxy_send_timeout    300s;
    client_max_body_size  25m;

    # ---------- CORS común para API ----------
    add_header 'Access-Control-Allow-Origin'      $http_origin    always;
    add_header 'Vary'                             'Origin'        always;
    add_header 'Access-Control-Allow-Credentials' 'true'          always;
    add_header 'Access-Control-Allow-Methods'     'GET,POST,PUT,PATCH,DELETE,OPTIONS' always;
    add_header 'Access-Control-Allow-Headers'     'Authorization,Content-Type,X-Requested-With' always;
    add_header 'Access-Control-Expose-Headers'    'Content-Length,Content-Type,X-Request-Id' always;
    if ($request_method = OPTIONS) { return 204; }

    # El API entrega JSON: oculta cabeceras HTML (evita "bad header line" en BusyBox wget)
    proxy_hide_header Content-Security-Policy;
    proxy_hide_header Permissions-Policy;

    proxy_buffering off;   # útil para SSE
  }

  # ========= Frontend HTML (SPA) =========
  location / {
    # Cabeceras de seguridad SOLO para HTML
    add_header Content-Security-Policy "default-src 'self'; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-eval'; connect-src 'self' http: https: ws: wss:; frame-src 'self' *; frame-ancestors 'self' https://zajuna.sena.edu.co http://localhost:8080 http://localhost:5173;" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), autoplay=(), clipboard-write=()" always;
    add_header X-Frame-Options "SAMEORIGIN" always;

    # SPA fallback
    try_files $uri /index.html;
  }

  # ========= Pasarela /chat hacia el backend (mantiene tu lógica) =========
  location /chat/ {
    proxy_pass http://backend_upstream/chat/;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
  }

  location = /chat         { add_header Cache-Control "no-cache, no-store, must-revalidate"; try_files /index.html =404; }
  location = /chat-embed   { add_header Cache-Control "no-cache, no-store, must-revalidate"; try_files /index.html =404; }
  location = /iframe/chat  { add_header Cache-Control "no-cache, no-store, must-revalidate"; try_files /index.html =404; }
  location = /widget       { add_header Cache-Control "no-cache, no-store, must-revalidate"; try_files /index.html =404; }

  # Atajos directos (si los usas por host raíz)
  location = /health      { proxy_pass http://backend_upstream/health;      }
  location = /auth/me     { proxy_pass http://backend_upstream/auth/me;     }
  location = /auth/logout { proxy_pass http://backend_upstream/auth/logout; }

  # ========= Pasarela Rasa HTTP directa (si la usas fuera de /api/chat/rasa/) =========
  location /rasa/ {
    proxy_pass http://rasa_upstream/;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
  }

  # ========= Pasarela Rasa WebSocket =========
  location /ws/ {
    proxy_pass http://rasa_upstream/ws/;
    proxy_http_version 1.1;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
  }

  # ========= Assets estáticos =========
  location ~* \.(?:css|js|mjs|map|png|jpg|jpeg|gif|svg|ico|webp|woff2?|ttf|eot)$ {
    try_files $uri =404;
    expires 30d;
    add_header Cache-Control "public, max-age=2592000, immutable";
    access_log off;
  }

  # ========= /embed (hojas estilo del widget) =========
  location /embed/ {
    try_files $uri =404;
    expires 7d;
    add_header Cache-Control "public, max-age=604800";
  }

  # ========= Archivos especiales =========
  location = /mi-avatar.png   { try_files /mi-avatar.png =404; }
  location = /bot-avatar.png  { try_files /embed/bot-avatar.png /bot-avatar.png =404; }
  location = /bot-loading.png { try_files /embed/bot-loading.png /bot-loading.png =404; }

  # Manifest (evita “Syntax error” si no lo sirve estático correcto)
  location = /site.webmanifest {
    add_header Content-Type application/manifest+json;
    try_files /site.webmanifest =404;
  }

  location = /index.html {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Service-Worker-Allowed "/" always;
    try_files $uri =404;
  }

  location = /hybrid-host.html {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Service-Worker-Allowed "/" always;
    try_files /hybrid-host.html =404;
  }
}
