# ---------- Upstreams (DNS de Docker: nombres de servicio) ----------
upstream backend_upstream {
    server backend:8000;
    keepalive 32;
}

upstream rasa_upstream {
    server rasa:5005;
    keepalive 16;
}

# ---------- Mapa para WebSocket ----------
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
  listen 80 default_server;
  server_name _;

  root  /usr/share/nginx/html;
  index index.html;
  etag on;

  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  client_max_body_size 20m;

  add_header Permissions-Policy "autoplay=(), clipboard-write=(), microphone=(), camera=()" always;

  add_header Content-Security-Policy "default-src 'self';
    script-src 'self' 'unsafe-inline';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    media-src 'self' https:;
    connect-src 'self' https: http: ws: wss:;
    frame-src 'self'; 
    frame-ancestors 'self' https://zajuna.sena.edu.co http://localhost:8080 http://localhost:5173;
    upgrade-insecure-requests" always;

  location = /ping {
    add_header Content-Type text/plain;
    return 200 "ok\n";
  }

  location /api/ {
    proxy_pass http://backend_upstream/;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
  }

  location /chat/ {
    proxy_pass http://backend_upstream/chat/;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
  }

  location = /chat {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    try_files /index.html =404;
  }
  location = /chat-embed {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    try_files /index.html =404;
  }
  location = /iframe/chat {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    try_files /index.html =404;
  }
  location = /widget {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    try_files /index.html =404;
  }

  location = /health      { proxy_pass http://backend_upstream/health;      }
  location = /auth/me     { proxy_pass http://backend_upstream/auth/me;     }
  location = /auth/logout { proxy_pass http://backend_upstream/auth/logout; }

  location /rasa/ {
    proxy_pass http://rasa_upstream/;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
  }

  location /ws/ {
    proxy_pass http://rasa_upstream/ws/;
    proxy_http_version 1.1;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
  }

  location ~* \.(?:css|js|mjs|map|png|jpg|jpeg|gif|svg|ico|webp|woff2?|ttf|eot)$ {
    try_files $uri =404;
    expires 30d;
    add_header Cache-Control "public, max-age=2592000, immutable";
    access_log off;
  }

  location /embed/ {
    try_files $uri =404;
    expires 7d;
    add_header Cache-Control "public, max-age=604800";
  }

  location = /mi-avatar.png   { try_files /mi-avatar.png =404; }
  location = /bot-avatar.png  { try_files /embed/bot-avatar.png /bot-avatar.png =404; }
  location = /bot-loading.png { try_files /embed/bot-loading.png /bot-loading.png =404; }

  location = /index.html {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Service-Worker-Allowed "/" always;
    try_files $uri =404;
  }

  location = /hybrid-host.html {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Service-Worker-Allowed "/" always;
    try_files /hybrid-host.html =404;
  }

  location / {
    try_files $uri /index.html;
  }
}
