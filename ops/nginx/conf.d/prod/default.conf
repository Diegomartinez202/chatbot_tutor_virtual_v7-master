# ---------- Upstreams (DNS de Docker: nombres de servicio) ----------
upstream backend_upstream {
    server backend:8000;
    keepalive 32;
}

upstream rasa_upstream {
    server rasa:5005;
    keepalive 16;
}

# ---------- Mapa para WebSocket ----------
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
  listen 80 default_server;
  server_name _;

  root  /usr/share/nginx/html;
  index index.html;
  etag on;

  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  client_max_body_size 20m;

  # ‚ö†Ô∏è Cabeceras pensadas para HTML (el API NO las hereda; en /api/ las ocultamos)
  add_header Permissions-Policy "autoplay=(), clipboard-write=(), microphone=(), camera=()" always;
  add_header Content-Security-Policy "default-src 'self';
    script-src 'self' 'unsafe-inline';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    media-src 'self' https:;
    connect-src 'self' https: http: ws: wss:;
    frame-src 'self';
    frame-ancestors 'self' https://zajuna.sena.edu.co http://localhost:8080 http://localhost:5173;
    upgrade-insecure-requests" always;

  # ---- utilidades ----
  location = /ping {
    add_header Content-Type text/plain;
    return 200 "ok\n";
  }

  # Fallback avatar (evita 404)
  location = /user-avatar.png {
    try_files
        /embed/user-avatar.png
        /user-avatar.png
        /embed/bot-avatar.png
        /bot-avatar.png
        =404;
  }

  # ========= RASA v√≠a /api/chat/rasa/*  (DEBE ir ANTES del /api/ gen√©rico) =========
  # Mapea /api/chat/rasa/<...>  ‚Üí  /webhooks/<...> en Rasa
  # Ej: /api/chat/rasa/rest/webhook  ‚Üí  /webhooks/rest/webhook
  location ^~ /api/chat/rasa/ {
    proxy_pass         http://rasa_upstream/webhooks/;
    proxy_http_version 1.1;

    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    proxy_set_header   Upgrade           $http_upgrade;
    proxy_set_header   Connection        $connection_upgrade;

    proxy_read_timeout    300s;
    proxy_send_timeout    300s;
    client_max_body_size  25m;

    # CORS para Rasa si usas cookies/token
    add_header 'Access-Control-Allow-Origin'      $http_origin    always;
    add_header 'Vary'                             'Origin'        always;
    add_header 'Access-Control-Allow-Credentials' 'true'          always;
    add_header 'Access-Control-Allow-Methods'     'GET,POST,PUT,PATCH,DELETE,OPTIONS' always;
    add_header 'Access-Control-Allow-Headers'     'Authorization,Content-Type,X-Requested-With' always;
    add_header 'Access-Control-Expose-Headers'    'Content-Length,Content-Type,X-Request-Id' always;
    if ($request_method = OPTIONS) { return 204; }

    # No heredar cabeceras HTML (evita "bad header line" en clientes tipo wget/BusyBox)
    proxy_hide_header Content-Security-Policy;
    proxy_hide_header Permissions-Policy;

    proxy_buffering off;  # √∫til para streams/SSE
  }

  # ========= API gen√©rico ‚Üí FastAPI =========
  location /api/ {
    proxy_pass         http://backend_upstream;
    proxy_http_version 1.1;

    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    # WebSocket / Upgrade
    proxy_set_header   Upgrade           $http_upgrade;
    proxy_set_header   Connection        $connection_upgrade;

    proxy_read_timeout    300s;
    proxy_send_timeout    300s;
    client_max_body_size  25m;

    # CORS API
    add_header 'Access-Control-Allow-Origin'      $http_origin    always;
    add_header 'Vary'                             'Origin'        always;
    add_header 'Access-Control-Allow-Credentials' 'true'          always;
    add_header 'Access-Control-Allow-Methods'     'GET,POST,PUT,PATCH,DELETE,OPTIONS' always;
    add_header 'Access-Control-Allow-Headers'     'Authorization,Content-Type,X-Requested-With' always;
    add_header 'Access-Control-Expose-Headers'    'Content-Length,Content-Type,X-Request-Id' always;
    if ($request_method = OPTIONS) { return 204; }

    # No heredar cabeceras HTML
    proxy_hide_header Content-Security-Policy;
    proxy_hide_header Permissions-Policy;

    proxy_buffering off; 
  }

  location / {
    add_header Content-Security-Policy "default-src 'self'; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-eval'; connect-src 'self' http: https: ws: wss:; frame-src 'self' *; frame-ancestors 'self' https://zajuna.sena.edu.co http://localhost:8080 http://localhost:5173;" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), autoplay=(), clipboard-write=()" always;
    add_header X-Frame-Options "SAMEORIGIN" always;

    # SPA fallback
    try_files $uri /index.html;
  }

  location /chat/ {
    proxy_pass http://backend_upstream/chat/;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
  }

  location = /chat         { add_header Cache-Control "no-cache, no-store, must-revalidate"; try_files /index.html =404; }
  location = /chat-embed   { add_header Cache-Control "no-cache, no-store, must-revalidate"; try_files /index.html =404; }
  location = /iframe/chat  { add_header Cache-Control "no-cache, no-store, must-revalidate"; try_files /index.html =404; }
  location = /widget       { add_header Cache-Control "no-cache, no-store, must-revalidate"; try_files /index.html =404; }


  location = /health      { proxy_pass http://backend_upstream/health;      }
  location = /auth/me     { proxy_pass http://backend_upstream/auth/me;     }
  location = /auth/logout { proxy_pass http://backend_upstream/auth/logout; }
   
  location /static/ {
    proxy_pass         http://backend_upstream/static/;
    proxy_http_version 1.1;

    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

 
    proxy_hide_header Content-Security-Policy;
    proxy_hide_header Permissions-Policy;
  }

  location /rasa/ {
    proxy_pass http://rasa_upstream/;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
  }

  location /ws/ {
    proxy_pass http://rasa_upstream/ws/;
    proxy_http_version 1.1;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
  }

  location /guardian/ {
    proxy_pass http://autosave-guardian:8080/;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP         $remote_addr;

    add_header Access-Control-Allow-Origin      $http_origin    always;
    add_header Vary                             Origin          always;
    add_header Access-Control-Allow-Credentials true            always;
    add_header Access-Control-Allow-Methods     "GET, POST, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers     "Authorization, Content-Type, Origin" always;

    if ($request_method = OPTIONS) { return 204; }

    proxy_read_timeout  60s;
    proxy_send_timeout  60s;

    # Evita heredar CSP de HTML
    proxy_hide_header Content-Security-Policy;
    proxy_hide_header Permissions-Policy;

    proxy_buffering off;
  }
  # ========= Assets est√°ticos =========
  location ~* \.(?:css|js|mjs|map|png|jpg|jpeg|gif|svg|ico|webp|woff2?|ttf|eot)$ {
    try_files $uri =404;
    expires 30d;
    add_header Cache-Control "public, max-age=2592000, immutable";
    access_log off;
  }

  location = /docs {
    proxy_pass         http://backend_upstream/docs;
    proxy_http_version 1.1;

    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    proxy_hide_header Content-Security-Policy;
    proxy_hide_header Permissions-Policy;
  }

  location = /docs/oauth2-redirect {
    proxy_pass http://backend_upstream/docs/oauth2-redirect;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_hide_header Content-Security-Policy;
    proxy_hide_header Permissions-Policy;
  }

  # ======================================================
  # üìò ReDoc - /redoc -> Proxy al backend
  # ======================================================
  location = /redoc {
    proxy_pass         http://backend_upstream/redoc;
    proxy_http_version 1.1;

    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    proxy_hide_header Content-Security-Policy;
    proxy_hide_header Permissions-Policy;
  }

  # ========= /embed (hojas estilo del widget) =========
  location /embed/ {
    try_files $uri =404;
    expires 7d;
    add_header Cache-Control "public, max-age=604800";
  }

  # ========= Archivos especiales =========
  location = /mi-avatar.png   { try_files /mi-avatar.png =404; }
  location = /bot-avatar.png  { try_files /embed/bot-avatar.png /bot-avatar.png =404; }
  location = /bot-loading.png { try_files /embed/bot-loading.png /bot-loading.png =404; }

  # Manifest (evita ‚ÄúSyntax error‚Äù)
  location = /site.webmanifest {
    add_header Content-Type application/manifest+json;
    try_files /site.webmanifest =404;
  }

  location = /index.html {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Service-Worker-Allowed "/" always;
    try_files $uri =404;
  }

  location = /hybrid-host.html {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Service-Worker-Allowed "/" always;
    try_files /hybrid-host.html =404;
  }
}
