# ops/nginx/conf.d/prod/default.conf
server {
  listen 80 default_server;
  server_name _;

  # Raíz del build de Vite
  root  /usr/share/nginx/html;
  index index.html;
  etag on;

  # Seguridad mínima
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;

  # Salud
  location = /ping {
    add_header Content-Type text/plain;
    return 200 "ok\n";
  }

  # ---------- API → backend:8000 ----------
  location /api/ {
    proxy_pass http://backend:8000/;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;
  }

  # ---------- Rasa HTTP ----------
  location /rasa/ {
    proxy_pass http://rasa:5005/;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    proxy_read_timeout 120s;
  }

  # ---------- Rasa WS ----------
  location /ws/ {
    proxy_pass http://rasa:5005/ws/;
    proxy_http_version 1.1;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 120s;
  }

  # ---------- Assets (NO fallback) ----------
  # Evita que .css/.js/.woff2 terminen sirviendo index.html
  location ~* \.(?:css|js|mjs|map|png|jpg|jpeg|gif|svg|ico|webp|woff2?|ttf|eot)$ {
    try_files $uri =404;
    expires 30d;
    add_header Cache-Control "public, max-age=2592000, immutable";
    access_log off;
  }

  # ---------- Widget embebido (NO fallback) ----------
  location /embed/ {
    try_files $uri =404;
    expires 7d;
    add_header Cache-Control "public, max-age=604800";
  }

  # Avatares/loader puntuales (si los usas)
  location = /mi-avatar.png   { try_files /mi-avatar.png =404; }
  location = /bot-avatar.png  { try_files /embed/bot-avatar.png /bot-avatar.png =404; }
  location = /bot-loading.png { try_files /embed/bot-loading.png /bot-loading.png =404; }

  # ---------- HTML sin cache ----------
  location = /index.html {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    try_files $uri =404;
  }

  # ---------- SPA fallback SOLO para rutas de app ----------
  location / {
    try_files $uri /index.html;
  }
}
