# Configuración Nginx para producción/dev - Reverse Proxy (plantilla común)
# Nota: este vhost usa un server_name propio para no colisionar con otros.
#       No se carga en DEV/PROD a menos que lo incluyas en tu nginx.conf.

server {
    listen 80;                   # ← sin default_server para no chocar
    server_name common.local;    # ← nombre propio (puedes cambiarlo o apuntarlo en /etc/hosts)

    # ===============================
    # Frontend React (admin)
    # ===============================
    location / {
        proxy_pass         http://admin:80;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # ===============================
    # API Backend (FastAPI)
    # ===============================
    location /api/ {
        proxy_pass         http://backend:8000/;  # <- slash final
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # ===============================
    # Rasa HTTP API (bajo /rasa/)
    # ===============================
    location /rasa/ {
        proxy_pass         http://rasa:5005/;     # <- SLASH FINAL para conservar subrutas
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_buffering    off;

        # CORS básico
        add_header Access-Control-Allow-Origin  * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

        if ($request_method = OPTIONS) { return 204; }
    }

    # ===============================
    # Salud directa de Rasa
    # (http://common.local/rasa/status si apuntas el host)
    # ===============================
    location = /rasa/status {
        proxy_pass         http://rasa:5005/status;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin "*" always;
    }

    # ===============================
    # Rasa WebSocket
    # ===============================
    location /ws/ {
        proxy_pass         http://rasa:5005/ws/;  # <- slash final
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
}

