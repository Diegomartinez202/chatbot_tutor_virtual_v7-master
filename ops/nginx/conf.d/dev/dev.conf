# ops/nginx/conf.d/dev/dev.conf
# Nginx dev: expone admin-dev (5173), backend-dev (8000) y Rasa (5005) en localhost:8080

# WebSocket helpers (v√°lido aqu√≠ o en nginx.conf dentro de http{})
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

# ===== Upstreams DEV =====
upstream admin_up   { server admin-dev:5173 max_fails=3 fail_timeout=5s; }
upstream backend_up { server backend-dev:8000 max_fails=3 fail_timeout=5s; }
upstream rasa_up    { server rasa:5005 max_fails=3 fail_timeout=5s; }

server {
  listen 80 default_server;
  server_name _;

  client_max_body_size 50m;

  # Timeouts amplios para Vite/WebSocket en dev
  proxy_connect_timeout   5s;
  proxy_send_timeout      86400;
  proxy_read_timeout      86400;
  send_timeout            60s;

  # Si quieres rutas internas de Vite expl√≠citas, puedes mantenerlas, pero
  # el include ya maneja "/" hacia admin_up (Vite). Si las dejas, no chocan.
  # location /@vite/         { proxy_pass http://admin_up; proxy_set_header Host $host; }
  # location /@react-refresh { proxy_pass http://admin_up; proxy_set_header Host $host; }
  # location /node_modules/  { proxy_pass http://admin_up; proxy_set_header Host $host; }
  # location /vite/          { proxy_pass http://admin_up; proxy_set_header Host $host; }

  # Est√°ticos backend (siempre puedes dejar este bloque fuera del include)
  location /static/ {
    proxy_pass http://backend-dev:8000/static/;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    add_header Cross-Origin-Resource-Policy cross-origin always;
    add_header Cross-Origin-Embedder-Policy unsafe-none always;
    add_header Cache-Control "no-cache";
    add_header Permissions-Policy "geolocation=(), camera=(), microphone=(), autoplay=()" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  }

  # üëá Inyecta todos los locations comunes
  include /etc/nginx/conf.d/common/includes/locations.inc;
}
