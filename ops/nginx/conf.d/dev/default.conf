# \ops\nginx\conf.d\dev\default.conf

server {
  listen 80;
  server_name _;

  root  /usr/share/nginx/html;
  index index.html;

  # SPA React (no Vite, no :5173)
  location / {
    try_files $uri $uri/ /index.html;
  }

  # Widget embebido (/embed/*.js|.css)
  location /embed/ {
    try_files $uri =404;
  }

  # Avatares/loader (evita que lo busque en 5173)
  location = /mi-avatar.png   { try_files /mi-avatar.png =404; }
  location = /bot-avatar.png  { try_files /embed/bot-avatar.png /bot-avatar.png =404; }
  location = /bot-loading.png { try_files /embed/bot-loading.png /bot-loading.png =404; }

  # Backend DEV (ajusta host:puerto si difiere)
  location /api/ {
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_pass http://backend-dev:8000/;
  }

  # Rasa en /rasa/
  location /rasa/ {
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Quita el prefijo /rasa/ hacia Rasa
    rewrite ^/rasa/?(.*)$ /$1 break;

    proxy_pass http://rasa:5005/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade   $http_upgrade;
    proxy_set_header Connection "upgrade";

    # CORS Ãºtil en dev
    add_header Access-Control-Allow-Origin  * always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
    if ($request_method = OPTIONS) { return 204; }
  }

  # Salud directa de Rasa (para el healthcheck)
  location = /rasa/status {
    proxy_pass http://rasa:5005/status;
    proxy_set_header Host $host;
  }

  # PING para probar el vhost
  location = /ping {
    add_header Content-Type text/plain;
    return 200 "pong\n";
  }
}
