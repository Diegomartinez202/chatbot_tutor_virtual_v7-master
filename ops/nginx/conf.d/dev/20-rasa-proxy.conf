# ops/nginx/conf.d/dev/20-rasa-proxy.conf
# DEV: vhost específico para Rasa SIN upstreams locales para evitar duplicados.
# Se aísla con un server_name propio y no usa default_server.

server {
  listen 80;                     # ← sin default_server, no compite con dev/dev.conf
  server_name rasa-dev.local;    # ← apúntalo en /etc/hosts si lo vas a usar

  # Límites y timeouts cómodos en dev
  client_max_body_size 50m;
  proxy_connect_timeout 5s;
  proxy_send_timeout    86400;
  proxy_read_timeout    86400;
  send_timeout          60s;

  # ---------- RASA: Salud ----------
  location = /rasa/status {
    proxy_pass         http://rasa:5005/status;
    proxy_http_version 1.1;

    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    add_header Access-Control-Allow-Origin "*" always;
  }

  # ---------- RASA: HTTP API bajo /rasa/ ----------
  # /rasa/webhooks/rest/webhook -> http://rasa:5005/webhooks/rest/webhook
  location /rasa/ {
    proxy_pass         http://rasa:5005/;   # ← SLASH FINAL para preservar subrutas
    proxy_http_version 1.1;

    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_buffering    off;

    # WebSocket (si lo usas dentro de /rasa/)
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection "upgrade";

    # CORS mínimo (como lo tenías)
    add_header Access-Control-Allow-Origin  * always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

    if ($request_method = OPTIONS) { return 204; }
  }

  # ---------- RASA: WebSocket directo ----------
  location /ws/ {
    proxy_pass         http://rasa:5005/ws/;   # ← slash final
    proxy_http_version 1.1;

    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection $connection_upgrade;  # definido en nginx.dev.conf (map en http{})

    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
  }
}
